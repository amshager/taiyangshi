<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>天文时系统 Base</title>
    <style>
        /* === 1. 核心视觉系统 (Visual System) === */
        :root {
            --bg: #000000;
            --panel: #0f1012;
            --text: #e0e0e0;
            --accent: #00ff41; /* 矩阵绿 */
            --gold: #ffcc00;   /* 太阳金 */
            --cyan: #66fcf1;   /* 数据蓝 */
            --dim: #444;
        }
        body {
            background: var(--bg);
            color: var(--text);
            font-family: "Menlo", "Consolas", monospace;
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* === 2. 布局组件 (Layout) === */
        /* 顶部状态栏 */
        .header {
            padding: 10px 15px;
            border-bottom: 1px solid #222;
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            background: #050505;
            z-index: 10;
        }
        .status-ok { color: var(--accent); }
        .status-bad { color: #f00; }

        /* 滚动内容区 */
        .viewport {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-bottom: 80px; /* 底部留白 */
        }

        /* 罗盘容器 */
        .compass-container {
            width: 340px;
            height: 340px;
            margin: 20px 0;
            position: relative;
        }

        /* 数字时间 */
        .digital-clock { text-align: center; margin-bottom: 15px; }
        .time-display {
            font-size: 2.8rem;
            font-weight: 300;
            color: var(--accent);
            letter-spacing: 2px;
            font-variant-numeric: tabular-nums; /* 等宽数字，防止秒针跳动抖动 */
        }
        .std-display { font-size: 0.9rem; color: #666; margin-top: 5px; }

        /* 数据卡片网格 */
        .dashboard {
            width: 90%;
            max-width: 400px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .card {
            background: var(--panel);
            border: 1px solid #333;
            padding: 12px;
            border-radius: 6px;
        }
        .card-full { grid-column: span 2; }
        .lbl { font-size: 10px; color: #666; text-transform: uppercase; display: block; margin-bottom: 4px; }
        .val { font-size: 14px; font-weight: bold; color: var(--text); }
        
        /* 底部控制栏 */
        .controls {
            position: fixed;
            bottom: 0;
            width: 100%;
            background: rgba(10,10,10,0.95);
            border-top: 1px solid #333;
            padding: 15px;
            display: flex;
            justify-content: center;
            gap: 15px;
        }
        .btn {
            background: #222; color: #fff; border: 1px solid #444;
            padding: 10px 20px; border-radius: 4px; cursor: pointer;
        }
        .btn:active { background: var(--accent); color: #000; }
    </style>
</head>
<body>

    <div class="header">
        <span id="gpsInfo" class="status-bad">GPS: 初始化...</span>
        <span>Astro-Chronometer V3.5</span>
    </div>

    <div class="viewport">
        <div class="compass-container">
            <svg viewBox="0 0 300 300" width="100%" height="100%">
                <defs>
                    <mask id="nightMask">
                        <rect x="-150" y="-150" width="600" height="600" fill="white"/>
                        <path id="daySectorMask" d="M0,0" fill="black" />
                    </mask>
                </defs>

                <circle cx="150" cy="150" r="148" fill="#050505" stroke="#333" stroke-width="1"/>
                <circle cx="150" cy="150" r="148" fill="rgba(0, 30, 80, 0.5)" mask="url(#nightMask)" />

                <g transform="translate(150,150)">
                    
                    <g id="layerFixed"></g>

                    <g id="layerZodiac"></g>

                    <g id="layerStars"></g>

                    <g id="handSun">
                        <line x1="0" y1="0" x2="0" y2="-110" stroke="var(--gold)" stroke-width="2" />
                        <circle cx="0" cy="-110" r="4" fill="var(--gold)" />
                    </g>
                    <g id="handMoon">
                        <line x1="0" y1="0" x2="0" y2="-130" stroke="var(--cyan)" stroke-width="1.5" stroke-dasharray="4,2" />
                        <circle cx="0" cy="-130" r="3" fill="#000" stroke="var(--cyan)" stroke-width="1"/>
                    </g>
                </g>

                <circle cx="150" cy="150" r="3" fill="#fff" />
            </svg>
        </div>

        <div class="digital-clock">
            <div class="time-display" id="clockTrue">00:00:00</div>
            <div class="std-display" id="clockStd">标准时 00:00:00</div>
        </div>

        <div class="dashboard">
            <div class="card card-full">
                <span class="lbl">时辰 (Time Period)</span>
                <span class="val" id="valShichen" style="color:var(--gold)">--时 --刻</span>
            </div>
            <div class="card">
                <span class="lbl">太阳 (Sun)</span>
                <span class="val" id="valSun">--</span>
            </div>
            <div class="card">
                <span class="lbl">月亮 (Moon)</span>
                <span class="val" id="valMoon">--</span>
            </div>
        </div>
    </div>

    <div class="controls">
        <button class="btn" onclick="APP.reset()">复位 (Reset)</button>
    </div>

<script>
/**
 * 模块化重构 - V3.5 基石版
 * 目标：确保渲染循环 (Render Loop) 稳定运行，秒针平滑。
 */

// 1. 常量定义
const D2R = Math.PI / 180;
const ZHI = ["子","丑","寅","卯","辰","巳","午","未","申","酉","戌","亥"];
// 简易黄道十二宫 (占位，后续用精准数据)
const ZODIAC = ["白羊","金牛","双子","巨蟹","狮子","处女","天秤","天蝎","射手","摩羯","水瓶","双鱼"];
// 简易二十八宿 (占位)
const STARS = ["角","亢","氐","房","心","尾","箕","斗","牛","女","虚","危","室","壁","奎","娄","胃","昴","毕","觜","参","井","鬼","柳","星","张","翼","轸"];

// 2. 状态管理
const STATE = {
    lat: 39.90,
    lon: 116.40,
    now: new Date()
};

// 3. 核心工具函数
function pad(n) { return n.toString().padStart(2,'0'); }

// 4. 初始化绘制 (静态部分)
function initLayers() {
    // 绘制内圈时辰 (子在下，午在上)
    const g = document.getElementById('layerFixed');
    for(let i=0; i<12; i++) {
        // i=0(子) -> 180度, i=6(午) -> 0度
        // 角度 = (i + 6) * 30
        const ang = (i + 6) * 30;
        const rad = (ang - 90) * D2R; // SVG 0度在右边
        const r = 85;
        
        const txt = document.createElementNS("http://www.w3.org/2000/svg", "text");
        txt.textContent = ZHI[i];
        txt.setAttribute("x", r * Math.cos(rad));
        txt.setAttribute("y", r * Math.sin(rad));
        txt.setAttribute("fill", "var(--accent)");
        txt.setAttribute("font-size", "12");
        txt.setAttribute("text-anchor", "middle");
        txt.setAttribute("dominant-baseline", "middle");
        // 让文字正立
        // txt.setAttribute("transform", `rotate(${ang+90} ${r*Math.cos(rad)} ${r*Math.sin(rad)})`);
        g.appendChild(txt);
    }

    // 绘制黄道圈 (简易示意)
    const gZ = document.getElementById('layerZodiac');
    for(let i=0; i<12; i++) {
        const ang = -i * 30; // 逆时针
        const rad = (ang - 90) * D2R;
        const r = 110;
        const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
        line.setAttribute("x1", r*Math.cos(rad)); line.setAttribute("y1", r*Math.sin(rad));
        line.setAttribute("x2", (r-5)*Math.cos(rad)); line.setAttribute("y2", (r-5)*Math.sin(rad));
        line.setAttribute("stroke", "#444");
        gZ.appendChild(line);
        
        const t = document.createElementNS("http://www.w3.org/2000/svg", "text");
        t.textContent = ZODIAC[i];
        t.setAttribute("x", (r+12)*Math.cos(rad)); t.setAttribute("y", (r+12)*Math.sin(rad));
        t.setAttribute("fill", "#66fcf1");
        t.setAttribute("font-size", "8");
        t.setAttribute("text-anchor", "middle");
        t.setAttribute("dominant-baseline", "middle");
        t.setAttribute("transform", `rotate(${ang} ${(r+12)*Math.cos(rad)} ${(r+12)*Math.sin(rad)})`);
        gZ.appendChild(t);
    }
}

// 5. 主循环 (Heartbeat)
function update() {
    const now = new Date();
    STATE.now = now;

    // --- A. 真太阳时计算 (简易版 for testing) ---
    // 假设均时差为0，仅计算经度差 (为了测试秒针)
    // 真实版本会在这里加入 EoT
    const offsetMin = (STATE.lon - 120) * 4;
    const trueTimeMs = now.getTime() + offsetMin * 60000;
    const tTime = new Date(trueTimeMs);

    // --- B. 界面更新 ---
    
    // B1. 数字时间
    document.getElementById('clockTrue').innerText = 
        `${pad(tTime.getHours())}:${pad(tTime.getMinutes())}:${pad(tTime.getSeconds())}`;
    document.getElementById('clockStd').innerText = 
        `标准时 ${pad(now.getHours())}:${pad(now.getMinutes())}`;

    // B2. 罗盘指针 (重点检查这里！)
    const h = tTime.getHours();
    const m = tTime.getMinutes();
    const s = tTime.getSeconds();
    const ms = tTime.getMilliseconds();
    
    // 计算太阳角度 (平滑移动)
    // 12:00 = 0度
    // 角度 = (h + m/60 + s/3600 - 12) * 15
    const sunAngle = ((h + m/60 + s/3600 + ms/3600000) - 12) * 15;
    document.getElementById('handSun').setAttribute('transform', `rotate(${sunAngle})`);

    // 月亮指针 (模拟: 落后太阳一些)
    const moonAngle = sunAngle - 30; // 假数据，测试旋转
    document.getElementById('handMoon').setAttribute('transform', `rotate(${moonAngle})`);

    // 黄道层旋转 (对齐太阳)
    // 假设太阳在白羊0度 (Mock)
    const sunLon = 0; 
    const tropRot = sunAngle - sunLon;
    document.getElementById('layerZodiac').setAttribute('transform', `rotate(${tropRot})`);

    // B3. 数据卡片
    const zhiIdx = Math.floor((h+1)/2) % 12;
    document.getElementById('valShichen').innerText = `${ZHI[zhiIdx]}时`;

    // 下一帧
    requestAnimationFrame(update);
}

// 6. 启动逻辑
const APP = {
    init: () => {
        initLayers();
        
        // GPS 模拟启动
        if(navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(p => {
                STATE.lat = p.coords.latitude;
                STATE.lon = p.coords.longitude;
                const el = document.getElementById('gpsInfo');
                el.innerText = `GPS: 锁定 (${p.coords.accuracy.toFixed(0)}m)`;
                el.className = "status-ok";
            });
        }
        
        // 启动心跳
        requestAnimationFrame(update);
    },
    reset: () => {
        alert("已复位到当前时间");
    }
};

// 立即运行
APP.init();

</script>
</body>
</html>
