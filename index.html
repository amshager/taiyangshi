<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å…­å£¬çœŸæœºÂ·å¤©æ–‡æ˜Ÿç›˜</title>
    <style>
        :root {
            --bg-color: #050505;
            --main-color: #00ff41; 
            --warn-color: #ffcc00;
            --danger-color: #ff3333;
            --highlight-color: #00ccff;
            --dim-color: #1a2b1a;
            --text-color: #ccffcc;
            --day-bg: #1a1a1a;
            --night-bg: #000000;
        }
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Courier New', Courier, monospace;
            margin: 0;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
            -webkit-user-select: none;
            user-select: none;
        }
        
        /* é€šç”¨å¸ƒå±€ */
        .status-bar, .main-display, .controls, .data-grid { width: 95%; max-width: 450px; }
        
        /* 1. é¡¶éƒ¨çŠ¶æ€ */
        .status-bar {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            border-bottom: 1px solid var(--dim-color);
            padding-bottom: 5px;
            margin-bottom: 5px;
        }

        /* 2. ä¸»æ—¶é—´åŒº */
        .main-display { text-align: center; margin-bottom: 5px; position: relative; }
        .time-big {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--main-color);
            line-height: 1;
            font-feature-settings: "tnum";
            cursor: pointer;
        }
        .time-label { font-size: 0.7rem; color: #666; }
        
        /* æš‚åœæµ®å±‚ */
        .paused-badge {
            display: none;
            position: absolute;
            top: 0; right: 20px;
            background: var(--danger-color);
            color: #000;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
            animation: pulse 2s infinite;
        }
        .paused .paused-badge { display: block; }
        .paused .time-big { color: #888; }

        /* 3. æ˜Ÿç›˜å®¹å™¨ */
        .clock-wrapper {
            width: 340px;
            height: 340px;
            position: relative;
            margin: 5px 0;
        }

        /* 4. æ—¶è¾°ä¿¡æ¯æ¡ */
        .shichen-box {
            border: 1px solid var(--dim-color);
            background: #0a0a0a;
            padding: 8px;
            width: 95%; max-width: 450px;
            margin-top: 5px;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .shichen-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .shichen-title { font-size: 1.2rem; font-weight: bold; color: var(--warn-color); }
        .pause-btn {
            background: #222; border: 1px solid #444;
            color: var(--main-color);
            padding: 2px 10px; cursor: pointer;
            font-size: 1rem; border-radius: 4px;
        }
        .pause-btn:active { background: #444; }
        
        .shichen-range { font-size: 0.75rem; color: #888; display: flex; flex-direction: column;}
        .range-row { display: flex; justify-content: space-between; }
        .range-label { color: #555; }
        
        .progress-container {
            height: 4px; background: #222; width: 100%; position: relative;
            margin-top: 3px;
        }
        .progress-bar { height: 100%; background: var(--main-color); width: 0%; transition: width 1s linear; }
        .shichen-countdown { font-size: 0.75rem; text-align: right; color: #666; }

        /* 5. æ•°æ®é¢æ¿ */
        .data-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px;
            margin-top: 10px;
            font-size: 0.8rem;
        }
        .data-item {
            background: #0e0e0e;
            border: 1px solid #222;
            padding: 6px;
            display: flex;
            flex-direction: column;
        }
        .data-label { color: #555; font-size: 0.65rem; }
        .data-val { color: var(--text-color); font-weight: bold; margin-top: 2px; }
        .highlight-phase { color: var(--highlight-color); text-shadow: 0 0 5px var(--highlight-color); }
        .highlight-important { color: var(--warn-color); }

        /* 6. æ§åˆ¶é¢æ¿ */
        .controls { margin-top: 15px; border-top: 1px dashed #333; padding-top: 10px; }
        .btn-full {
            background: #111; color: var(--main-color); border: 1px solid #333;
            padding: 8px; width: 100%; text-align: center; cursor: pointer;
        }
        .manual-panel {
            display: none; background: #111; padding: 10px; border: 1px solid #333; margin-top: 5px;
        }
        .manual-panel.show { display: block; }
        .input-row { margin-bottom: 8px; }
        .input-row label { display: block; font-size: 0.7rem; color: #888; }
        .input-row input { width: 95%; background: #000; border: 1px solid #444; color: #fff; padding: 4px; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .flash-red { animation: flash 1s infinite; color: var(--danger-color); }
        @keyframes flash { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }

    </style>
</head>
<body>

    <div class="status-bar">
        <span id="gpsStatus">GPS: åˆå§‹åŒ–...</span>
        <span id="sysTimeDisplay">STD: --:--:--</span>
    </div>

    <div class="main-display" id="mainDisplay">
        <div class="paused-badge">PAUSED</div>
        <div class="time-big" id="trueSolarTime" onclick="togglePause()">00:00:00</div>
        <div class="time-label">çœŸå¤ªé˜³æ—¶ (True Solar Time)</div>
    </div>

    <div class="clock-wrapper">
        <svg viewBox="0 0 300 300" width="100%" height="100%">
            <defs>
                <pattern id="nightPattern" patternUnits="userSpaceOnUse" width="4" height="4">
                    <path d="M-1,1 l2,-2 M0,4 l4,-4 M3,5 l2,-2" style="stroke:#002200; stroke-width:1" />
                </pattern>
                <marker id="arrow" markerWidth="10" markerHeight="10" refX="0" refY="3" orient="auto" markerUnits="strokeWidth">
                  <path d="M0,0 L0,6 L9,3 z" fill="#f00" />
                </marker>
            </defs>

            <circle cx="150" cy="150" r="148" fill="#000" stroke="#333" stroke-width="1" />
            
            <path id="daySector" fill="#1a1a1a" d="" /> <path id="nightSector" fill="url(#nightPattern)" d="" /> <g id="dialFixed" transform="translate(150,150)">
                </g>

            <g id="dialZodiac" transform="translate(150,150)">
                <circle cx="0" cy="0" r="105" fill="none" stroke="#222" stroke-width="20" opacity="0.5"/>
                </g>

            <g id="dialStars" transform="translate(150,150)">
                <circle cx="0" cy="0" r="130" fill="none" stroke="#222" stroke-width="30" opacity="0.3"/>
                </g>

            <g id="sunHand" transform="translate(150,150)">
                <line x1="0" y1="0" x2="0" y2="-110" stroke="#ffcc00" stroke-width="2" />
                <circle cx="0" cy="-110" r="5" fill="#ffcc00" />
                <text x="0" y="-120" fill="#ffcc00" font-size="12" text-anchor="middle">â˜€</text>
            </g>

            <g id="moonHand" transform="translate(150,150)">
                <line x1="0" y1="0" x2="0" y2="-135" stroke="#00ccff" stroke-width="1.5" stroke-dasharray="3,2" />
                <g id="moonIconGroup" transform="translate(0, -135)">
                    <circle r="6" fill="#000" stroke="#00ccff" stroke-width="1"/>
                    <path id="moonPhaseShape" d="" fill="#00ccff" />
                </g>
            </g>

            <circle cx="150" cy="150" r="3" fill="#00ff41" />
        </svg>
    </div>

    <div class="shichen-box">
        <div class="shichen-header">
            <span class="shichen-title" id="shichenName">--æ—¶</span>
            <button class="pause-btn" onclick="togglePause()" id="pauseBtn">â¸</button>
        </div>
        <div class="shichen-range">
            <div class="range-row">
                <span class="range-label">çœŸå¤ªé˜³æ—¶:</span>
                <span id="rangeTrue">--:-- ~ --:--</span>
            </div>
            <div class="range-row">
                <span class="range-label">æ‰‹è¡¨æ—¶é—´:</span>
                <span id="rangeStd" style="color:var(--highlight-color)">--:-- ~ --:--</span>
            </div>
        </div>
        <div class="progress-container"><div class="progress-bar" id="shichenBar"></div></div>
        <div class="shichen-countdown" id="shichenCount">--</div>
    </div>

    <div class="data-grid">
        <div class="data-item">
            <span class="data-label">å›å½’é»„é“å®« (æ°”)</span>
            <span class="data-val" id="valZodiac">--</span>
        </div>
        <div class="data-item">
            <span class="data-label">å®æµ‹äºŒåå…«å®¿ (è´¨)</span>
            <span class="data-val" id="valStar">--</span>
        </div>
        <div class="data-item">
            <span class="data-label">æœˆç›¸ (Phase)</span>
            <span class="data-val" id="valPhase">--</span>
        </div>
        <div class="data-item">
            <span class="data-label">æ—¥å‡º/æ—¥è½ (çœŸ)</span>
            <span class="data-val" id="valSunTimes">-- / --</span>
        </div>
        <div class="data-item" style="grid-column: span 2;">
            <span class="data-label">ä½ç½® / åå·®</span>
            <span class="data-val" style="font-size:0.7rem" id="valLoc">Lon: -- Lat: --</span>
            <span class="data-val" style="font-size:0.7rem" id="valDiff">Diff: --</span>
        </div>
    </div>

    <div class="controls">
        <div class="btn-full" onclick="toggleMode()" id="modeBtn">åˆ‡æ¢ï¼šæ‰‹åŠ¨/éªŒè¯æ¨¡å¼</div>
        <div class="manual-panel" id="manualPanel">
            <div class="input-row">
                <label>æ—¥æœŸæ—¶é—´</label>
                <input type="datetime-local" id="manualTime" step="1">
            </div>
            <div class="input-row">
                <label>ç»åº¦ (E+, W-)</label>
                <input type="number" id="manualLon" value="113.83" step="0.0001">
            </div>
            <div class="input-row">
                <label>çº¬åº¦ (N+, S-)</label>
                <input type="number" id="manualLat" value="23.30" step="0.0001">
            </div>
            <div class="btn-full" onclick="applyManual()" style="border-color:#fff; color:#fff; margin-top:5px;">åº”ç”¨è®¾å®š</div>
            <div class="btn-full" onclick="setNow()" style="font-size:0.8rem; border:none; color:#888;">è®¾ä¸ºç°åœ¨</div>
        </div>
    </div>

<script>
/**
 * V3.0 å…­å£¬çœŸæœºÂ·å¤©æ–‡å¼•æ“
 * ç‰¹æ€§ï¼šå›å½’å®«ä½ + æ’æ˜Ÿå®¿åº¦ + æœˆç›¸é«˜äº® + æ—¶é—´å†»ç»“
 */

// === å…¨å±€çŠ¶æ€ ===
const APP = {
    mode: 'gps', // 'gps' | 'manual'
    paused: false,
    lat: 39.9042, // é»˜è®¤åŒ—äº¬
    lon: 116.4074,
    gpsAcc: 0,
    baseTime: new Date(), // çœŸå®ç³»ç»Ÿæ—¶é—´
    frozenTime: null,     // æš‚åœæ—¶çš„æ—¶é—´
    manualOffset: 0       // æ‰‹åŠ¨æ¨¡å¼çš„æ—¶é—´å·®
};

// === å¤©æ–‡æ•°æ®å¸¸é‡ ===
// äºŒåå…«å®¿ (J2000 æ’æ˜Ÿé»„ç»)
// ä¿®æ­£é€»è¾‘ï¼šè§’å®¿ä¸€(Spica)åœ¨ J2000 çº¦ 203.8åº¦(å›å½’)ã€‚
// ä½†ä¸ºäº†è¿˜åŸå¤ç±ä¸æ˜Ÿå›¾å¯¹åº”ï¼Œæˆ‘ä»¬ä½¿ç”¨ç°ä»£æµ‹å®šè¾¹ç•Œã€‚
// é¡ºåºï¼šè§’äº¢æ°æˆ¿å¿ƒå°¾ç®•...
const XIU_DATA = [
    {n:"è§’", d:201.2}, {n:"äº¢", d:212.3}, {n:"æ°", d:221.7}, {n:"æˆ¿", d:238.6},
    {n:"å¿ƒ", d:244.7}, {n:"å°¾", d:252.0}, {n:"ç®•", d:268.3}, {n:"æ–—", d:277.6},
    {n:"ç‰›", d:302.3}, {n:"å¥³", d:309.8}, {n:"è™š", d:321.2}, {n:"å±", d:331.0},
    {n:"å®¤", d:348.6}, {n:"å£", d:5.1},   {n:"å¥", d:10.5},  {n:"å¨„", d:24.5},
    {n:"èƒƒ", d:37.8},  {n:"æ˜´", d:52.3},  {n:"æ¯•", d:61.2},  {n:"è§œ", d:76.8},
    {n:"å‚", d:77.8},  {n:"äº•", d:88.6},  {n:"é¬¼", d:120.5}, {n:"æŸ³", d:124.9},
    {n:"æ˜Ÿ", d:139.3}, {n:"å¼ ", d:147.2}, {n:"ç¿¼", d:164.7}, {n:"è½¸", d:184.4}
];
// å¯(å¤©è)å¯¹åº”å®«ä½. 
// å›å½’é»„é“å®«ä½ï¼šç™½ç¾Š0, é‡‘ç‰›30... 
// å¯¹åº”åœ°æ”¯(å…­å£¬/å…«å­—æœˆå°†): æˆŒ=ç™½ç¾Š, é…‰=é‡‘ç‰›, ç”³=åŒå­, æœª=å·¨èŸ¹, åˆ=ç‹®å­, å·³=å¤„å¥³, è¾°=å¤©ç§¤, å¯=å¤©è, å¯…=å°„æ‰‹, ä¸‘=æ‘©ç¾¯, å­=æ°´ç“¶, äº¥=åŒé±¼
const ZODIAC_GONGS = [
    {n:"æˆŒ/ç™½ç¾Š", d:0}, {n:"é…‰/é‡‘ç‰›", d:30}, {n:"ç”³/åŒå­", d:60}, {n:"æœª/å·¨èŸ¹", d:90},
    {n:"åˆ/ç‹®å­", d:120}, {n:"å·³/å¤„å¥³", d:150}, {n:"è¾°/å¤©ç§¤", d:180}, {n:"å¯/å¤©è", d:210},
    {n:"å¯…/å°„æ‰‹", d:240}, {n:"ä¸‘/æ‘©ç¾¯", d:270}, {n:"å­/æ°´ç“¶", d:300}, {n:"äº¥/åŒé±¼", d:330}
];
const SHICHEN = ["å­","ä¸‘","å¯…","å¯","è¾°","å·³","åˆ","æœª","ç”³","é…‰","æˆŒ","äº¥"];

// === æ•°å­¦å·¥å…· ===
const D2R = Math.PI / 180;
const R2D = 180 / Math.PI;
function sin(d) { return Math.sin(d * D2R); }
function cos(d) { return Math.cos(d * D2R); }
function norm360(d) { return (d % 360 + 360) % 360; }

// === æ ¸å¿ƒç®€æ˜“å¤©æ–‡ç®—æ³• ===
// è®¡ç®— MJD
function getJ2000Days(date) { return (date.getTime()/86400000) - 10957.5; }

// å¤ªé˜³é»„ç» (å›å½’)
function getSunLon(date) {
    const d = getJ2000Days(date);
    const M = 357.529 + 0.98560028 * d;
    const L = 280.459 + 0.98564736 * d;
    const lambda = L + 1.915*sin(M) + 0.020*sin(2*M);
    return norm360(lambda);
}

// æœˆäº®é»„ç» (å›å½’) & æœˆç›¸
function getMoonData(date) {
    const d = getJ2000Days(date);
    const L = 218.316 + 13.176396 * d;
    const M = 134.963 + 13.064993 * d;
    const F = 93.272 + 13.229350 * d;
    const lambda = L + 6.289 * sin(M);
    return norm360(lambda);
}

// å‡æ—¶å·®
function getEoT(date) {
    const d = getJ2000Days(date); // ç²—ç•¥
    // æ›´å‡†çš„ç®—æ³•
    const start = new Date(date.getFullYear(), 0, 0);
    const diff = date - start;
    const oneDay = 86400000;
    const day = Math.floor(diff / oneDay);
    const B = (360 / 365) * (day - 81) * D2R;
    return 9.87*Math.sin(2*B) - 7.53*Math.cos(B) - 1.5*Math.sin(B);
}

// æ—¥å‡ºæ—¥è½ (è¿”å›çœŸå¤ªé˜³æ—¶åˆ†é’Ÿæ•°)
function getSunTimes(date, lat) {
    const sunLon = getSunLon(date);
    // å¤ªé˜³èµ¤çº¬
    const dec = Math.asin(sin(sunLon) * sin(23.44)) * R2D;
    // æ—¶è§’ cos H
    const cosH = -Math.tan(lat * D2R) * Math.tan(dec * D2R);
    if (cosH > 1 || cosH < -1) return null; // ææ˜¼å¤œ
    const H = Math.acos(cosH) * R2D;
    const minOffset = H * 4;
    return { rise: 720 - minOffset, set: 720 + minOffset };
}

// === ç»˜å›¾åˆå§‹åŒ– ===
function initSVG() {
    // 1. ç»˜åˆ¶å›ºå®šå†…åœˆ (æ—¶è¾°)
    const g = document.getElementById('dialFixed');
    SHICHEN.forEach((z, i) => {
        // åˆ(6)åœ¨æœ€ä¸Šé¢(0åº¦), å­(0)åœ¨æœ€ä¸‹é¢(180)
        // æ˜ å°„: 0(å­)->180, 6(åˆ)->0/360
        // i: 0..11. 
        // Angle = (i - 6) * 30 + 180 ?
        // å­(0): (0-6)*30 = -180 + 180 = 0? ä¸å¯¹ã€‚
        // æˆ‘ä»¬å¸Œæœ› åˆ(6) åœ¨ Top (-90 in SVG coord, or 0 in rotation).
        // è®©æˆ‘ä»¬ç”¨æ ‡å‡†é’Ÿè¡¨é€»è¾‘: 12ç‚¹(Top) = 0åº¦.
        // å­(0) = 24ç‚¹/0ç‚¹ = Bottom = 180åº¦.
        // åˆ(6) = 12ç‚¹ = Top = 0åº¦.
        // Angle = (i + 6) * 30 % 360 ?
        // 0(å­): 6*30=180 (Bottom). 6(åˆ): 12*30=360=0 (Top). Correct.
        const angle = (i + 6) * 30; 
        
        // åˆ»åº¦çº¿
        const r1 = 80, r2 = 90;
        const rad = (angle - 90) * D2R; // SVG sin/cos use 0 at 3 o'clock
        const x1 = r1 * Math.cos(rad), y1 = r1 * Math.sin(rad);
        const x2 = r2 * Math.cos(rad), y2 = r2 * Math.sin(rad);
        
        const line = createSVG('line', {x1, y1, x2, y2, stroke:'#00ff41', 'stroke-width':1});
        g.appendChild(line);
        
        // æ–‡å­—
        const rT = 70;
        const tx = rT * Math.cos(rad), ty = rT * Math.sin(rad);
        const txt = createSVG('text', {x:tx, y:ty+4, fill:'#00ff41', 'font-size':12, 'text-anchor':'middle', 'font-weight':'bold'});
        txt.textContent = z;
        // æ—‹è½¬æ–‡å­—ä½¿å…¶æ­£ç«‹ (å¯é€‰)
        g.appendChild(txt);
    });

    // 2. ç»˜åˆ¶å›å½’é»„é“åœˆ (Gongs)
    const gZ = document.getElementById('dialZodiac');
    ZODIAC_GONGS.forEach((z) => {
        // z.d æ˜¯èµ·å§‹åº¦æ•° (ç™½ç¾Š0). 
        // ç”»åˆ»åº¦
        const angle = -z.d - 90; // é€†æ—¶é’ˆ? é»„é“æ˜¯é€†æ—¶é’ˆæ’åˆ—çš„
        // ç™½ç¾Š0, é‡‘ç‰›30...
        // åœ¨è¡¨ç›˜ä¸Šï¼Œå¦‚æœç™½ç¾Šåœ¨Top, é‡‘ç‰›åœ¨Left(é€†æ—¶é’ˆ)
        // æˆ‘ä»¬ç”¨ line
        const r1 = 95, r2 = 115;
        // å°†åº¦æ•°è½¬æ¢ä¸º SVG åæ ‡ (0åº¦åœ¨å³)
        // æˆ‘ä»¬å‡è®¾ 0åº¦(ç™½ç¾Š) å¯¹åº” 0åº¦è§’
        // å®é™…ä¸Šæˆ‘ä»¬æœ€åä¼šæ—‹è½¬æ•´ä¸ª Group
        const rad = (z.d) * D2R; // æ­£å¸¸ç”»
        // æ–‡å­—æ”¾åœ¨ä¸­é—´
        const midRad = (z.d + 15) * D2R;
        
        // è¿™é‡Œåªæ˜¯ç”»ç›˜é¢ç»“æ„ï¼Œä¸éœ€è¦æ—‹è½¬
        // åˆ»åº¦
        const lx1 = r1 * Math.cos(rad), ly1 = r1 * Math.sin(rad);
        const lx2 = r2 * Math.cos(rad), ly2 = r2 * Math.sin(rad);
        gZ.appendChild(createSVG('line', {x1:lx1, y1:ly1, x2:lx2, y2:ly2, stroke:'#333', 'stroke-width':1}));
        
        // æ–‡å­—
        const rt = 105;
        const tx = rt * Math.cos(midRad), ty = rt * Math.sin(midRad);
        const txt = createSVG('text', {x:tx, y:ty, fill:'#888', 'font-size':8, 'text-anchor':'middle', transform:`rotate(${z.d+15+90}, ${tx}, ${ty})`});
        txt.textContent = z.n.split('/')[1]; // åªæ˜¾ç¤ºæ˜Ÿåº§åï¼Œç®€æ´
        gZ.appendChild(txt);
    });

    // 3. ç»˜åˆ¶äºŒåå…«å®¿åœˆ
    const gS = document.getElementById('dialStars');
    // éœ€è¦æ’åºå¤„ç†è·¨0åº¦
    let sortedXiu = [...XIU_DATA].sort((a,b) => a.d - b.d);
    // å¤„ç†å£å®¿ (5.1 -> 365.1 for sorting context, but draw correctly)
    
    for(let i=0; i<sortedXiu.length; i++) {
        let curr = sortedXiu[i];
        let next = sortedXiu[(i+1)%sortedXiu.length];
        
        // åˆ»åº¦çº¿ (èµ·å§‹ä½ç½®)
        const r1 = 115, r2 = 145;
        const rad = curr.d * D2R;
        const lx1 = r1 * Math.cos(rad), ly1 = r1 * Math.sin(rad);
        const lx2 = r2 * Math.cos(rad), ly2 = r2 * Math.sin(rad);
        gS.appendChild(createSVG('line', {x1:lx1, y1:ly1, x2:lx2, y2:ly2, stroke:'#444', 'stroke-width':1}));
        
        // æ–‡å­— (åŒºé—´ä¸­é—´)
        let start = curr.d;
        let end = next.d;
        if (end < start) end += 360;
        let mid = (start + end) / 2;
        
        const rt = 130;
        const mRad = mid * D2R;
        const tx = rt * Math.cos(mRad), ty = rt * Math.sin(mRad);
        const txt = createSVG('text', {x:tx, y:ty, fill:'#555', 'font-size':9, 'text-anchor':'middle', transform:`rotate(${mid+90}, ${tx}, ${ty})`});
        txt.textContent = curr.n;
        gS.appendChild(txt);
    }
}

function createSVG(type, attrs) {
    const el = document.createElementNS("http://www.w3.org/2000/svg", type);
    for (let k in attrs) el.setAttribute(k, attrs[k]);
    return el;
}

// === æ ¸å¿ƒé€»è¾‘å¾ªç¯ ===
function update() {
    if (!APP.paused) {
        APP.baseTime = new Date();
    }
    
    // 1. ç¡®å®šè®¡ç®—æ—¶é—´
    let calcTime = APP.paused ? APP.frozenTime : APP.baseTime;
    if (APP.mode === 'manual') {
        calcTime = new Date(calcTime.getTime() + APP.manualOffset);
        // å¦‚æœä¸æ˜¯æš‚åœçŠ¶æ€ï¼Œæ‰‹åŠ¨æ¨¡å¼ä¸‹ manualOffset æ˜¯å›ºå®šçš„ï¼Œæ‰€ä»¥ calcTime ä¼šéš baseTime èµ°
        // å¦‚æœè¦å®Œå…¨å®šæ ¼æ‰‹åŠ¨è¾“å…¥çš„æ—¶é—´ï¼Œåº”è¯¥åœ¨ applyManual æ—¶ pause
    }

    // 2. åŸºç¡€å¤©æ–‡å‚æ•°
    const eot = getEoT(calcTime);
    const lonCorr = (APP.lon - 120) * 4;
    const totalOff = eot + lonCorr; // åˆ†é’Ÿ
    
    // çœŸå¤ªé˜³æ—¶å¯¹è±¡
    const trueTime = new Date(calcTime.getTime() + totalOff * 60000);
    
    // 3. ç•Œé¢æ˜¾ç¤ºæ—¶é—´
    renderTimeDisplay(trueTime, totalOff);
    
    // 4. æ˜Ÿç›˜æ—‹è½¬é€»è¾‘ (æ ¸å¿ƒ)
    updateClockFace(trueTime, calcTime, APP.lat, APP.lon);
    
    // 5. æ•°æ®é¢æ¿æ›´æ–°
    updateDataPanel(trueTime, calcTime);
    
    requestAnimationFrame(update);
}

// æ¸²æŸ“æ•°å­—æ—¶é—´ä¸è¿›åº¦
function renderTimeDisplay(t, offset) {
    const h = t.getHours(), m = t.getMinutes(), s = t.getSeconds();
    const str = `${pad(h)}:${pad(m)}:${pad(s)}`;
    document.getElementById('trueSolarTime').innerText = str;
    
    // æ—¶è¾°é€»è¾‘
    // çœŸå¤ªé˜³æ—¶ h
    // 11-13 åˆ. (h+1)/2 floor % 12
    const zhiIdx = Math.floor((h + 1) / 2) % 12;
    const currZhi = SHICHEN[zhiIdx];
    document.getElementById('shichenName').innerText = currZhi + "æ—¶";
    
    // è¿›åº¦æ¡
    // èµ·ç‚¹: å¥‡æ•°å°æ—¶. 11, 13, 15...
    // å¦‚æœ h=12, start=11. h=11, start=11.
    const startH = (h % 2 !== 0) ? h : h - 1;
    // å¤„ç†å­æ—¶è·¨å¤© (23, 0) -> start 23
    let sH = (h===0) ? 23 : startH;
    
    // å½“å‰ç§’æ•° (ä» startH:00:00 å¼€å§‹)
    // ç®€å•ç®—: (h*3600 + m*60 + s) - (sH*3600)
    // éœ€å¤„ç† h=0, sH=23 çš„æƒ…å†µ -> (24*3600 + ...) - (23*3600)
    let currSecs = (h*3600 + m*60 + s);
    if (h < sH) currSecs += 24*3600;
    const startSecs = sH * 3600;
    const passed = currSecs - startSecs;
    const total = 7200; // 2å°æ—¶
    const pct = Math.min(100, Math.max(0, (passed/total)*100));
    
    const bar = document.getElementById('shichenBar');
    bar.style.width = pct + "%";
    
    // å€’è®¡æ—¶
    const left = total - passed;
    const lm = Math.floor(left / 60);
    const ls = left % 60;
    document.getElementById('shichenCount').innerText = `å‰© ${lm}åˆ†${ls}ç§’`;
    
    // é¢œè‰²è­¦æŠ¥
    const title = document.getElementById('shichenName');
    if (lm < 1) {
        bar.style.background = "var(--danger-color)";
        title.classList.add('flash-red');
    } else if (lm < 15) {
        bar.style.background = "var(--warn-color)";
        title.classList.remove('flash-red');
    } else {
        bar.style.background = "var(--main-color)";
        title.classList.remove('flash-red');
    }

    // æ ‡å‡†æ—¶é—´å¯¹ç…§èŒƒå›´
    // çœŸå¤ªé˜³æ—¶ startH:00 ~ startH+2:00
    // æ ‡å‡†æ—¶ = çœŸ - offset
    // ä¹Ÿå°±æ˜¯: (startH:00 - offset) ~ (endH:00 - offset)
    const rangeTrue = `${pad(sH)}:00 ~ ${pad((sH+2)%24)}:00`;
    
    // è®¡ç®—æ ‡å‡†èµ·æ­¢
    const stdStartM = (sH * 60) - offset; 
    const stdEndM = ((sH+2) * 60) - offset;
    
    document.getElementById('rangeTrue').innerText = rangeTrue;
    document.getElementById('rangeStd').innerText = `${fmtMin(stdStartM)} ~ ${fmtMin(stdEndM)}`;
    
    // é¡¶éƒ¨çŠ¶æ€
    const sys = APP.paused ? APP.frozenTime : APP.baseTime;
    document.getElementById('sysTimeDisplay').innerText = "STD: " + sys.toLocaleTimeString('en-GB');
}

// æ ¸å¿ƒï¼šæ—‹è½¬è¡¨ç›˜
function updateClockFace(trueTime, utcTime, lat, lon) {
    // 1. è®¡ç®—å¤ªé˜³è§’åº¦ (ç”¨äºæŒ‡é’ˆ)
    // çœŸå¤ªé˜³æ—¶ 12:00 æŒ‡å‘æ­£ä¸Šæ–¹ (0åº¦ in rotation transform)
    // 24å°æ—¶åˆ¶è½¬è§’åº¦: (h + m/60 + s/3600 - 12) * 15
    const h = trueTime.getHours();
    const m = trueTime.getMinutes();
    const s = trueTime.getSeconds();
    const decTime = h + m/60 + s/3600;
    const sunAngle = (decTime - 12) * 15;
    
    // æ—‹è½¬å¤ªé˜³æŒ‡é’ˆ
    document.getElementById('sunHand').setAttribute('transform', `translate(150,150) rotate(${sunAngle})`);
    
    // 2. æ—‹è½¬é»„é“åœˆä¸å®¿åº¦åœˆ
    // é€»è¾‘ï¼šå¤ªé˜³æŒ‡é’ˆæ°¸è¿œæŒ‡å‘å½“å‰çœŸå¤ªé˜³æ—¶ã€‚
    // è€Œå¤ªé˜³åœ¨é»„é“ä¸Šçš„ä½ç½®æ˜¯å›ºå®šçš„ (æ¯”å¦‚ä»Šå¤©å¤ªé˜³åœ¨ å¤©è24åº¦)ã€‚
    // æ‰€ä»¥ï¼Œé»„é“åœˆå¿…é¡»æ—‹è½¬ï¼Œä½¿å¾— "å¤©è24åº¦" åˆšå¥½å¯¹å‡† å¤ªé˜³æŒ‡é’ˆã€‚
    
    const sunLon = getSunLon(utcTime); // å›å½’é»„ç» (0=ç™½ç¾Š)
    // SVGä¸­ï¼Œæˆ‘ä»¬ç”»çš„æ—¶å€™ï¼Œç™½ç¾Š0åº¦æ˜¯åœ¨ "å³è¾¹" (0 deg math angle) è¿˜æ˜¯ Top? 
    // å‰é¢ä»£ç ç»˜åˆ¶æ—¶ï¼š rad = z.d * D2R. SVGåæ ‡ç³» 0åº¦åœ¨3ç‚¹é’Ÿæ–¹å‘.
    // æˆ‘ä»¬å¸Œæœ›ï¼šå¦‚æœ SunLon = 0 (ç™½ç¾Š)ï¼Œä¸”ç°åœ¨æ˜¯ 12:00 (SunPointer at Top/-90deg).
    // é‚£ä¹ˆç™½ç¾Šåˆ»åº¦åº”è¯¥åœ¨ Top.
    // ç»˜åˆ¶æ—¶ï¼š0åº¦åˆ»åº¦åœ¨ 3ç‚¹é’Ÿ.
    // æ—‹è½¬é€»è¾‘:
    // Group Rotation = SunPointerAngle - SunLonAngleInGroup + Correction
    // SunPointer = sunAngle (0 at Top).
    // SunLonInGroup: 0 deg drawn at Right (90 deg from Top).
    // So if SunLon=0, Group 0deg is at Right. We want it at Top. Rotate -90.
    // Total Rotate = sunAngle - sunLon - 90.
    
    const zodiacRot = sunAngle - sunLon - 90;
    document.getElementById('dialZodiac').setAttribute('transform', `translate(150,150) rotate(${zodiacRot})`);
    
    // æ’æ˜Ÿé»„é“åœˆ (äºŒåå…«å®¿)
    // å®ƒä»¬åº”è¯¥è·Ÿç€é»„é“åœˆè½¬ï¼Œä½†æ˜¯è¦å‡å»å²å·®?
    // ä¸ï¼Œæˆ‘ä»¬ç”»å®¿åº¦æ—¶ç”¨çš„æ˜¯ J2000 æ’æ˜Ÿé»„ç»ã€‚
    // ç°åœ¨çš„å¤ªé˜³å›å½’é»„ç» sunLon (æ¯”å¦‚ 240åº¦) å¯¹åº”æ’æ˜Ÿä½ç½®æ˜¯å¤šå°‘?
    // å²å·® Precession: æ¯å¹´ 50.3ç§’. 2000 -> 2026 çº¦ 26å¹´.
    // Delta = 26 * 50.3 / 3600 = 0.36 åº¦? 
    // ä¸å¯¹ï¼Œå²å·®æ˜¯ç´¯ç§¯çš„ã€‚J2000åæ ‡ç³»æ˜¯å›ºå®šçš„ã€‚
    // å¤ªé˜³çš„"å›å½’é»„ç»"æ˜¯åŸºäºæ˜¥åˆ†ç‚¹çš„ã€‚æ˜¥åˆ†ç‚¹åœ¨åŠ¨(è¥¿é€€)ã€‚
    // æ‰€ä»¥ å¤ªé˜³å›å½’é»„ç» = å¤ªé˜³æ’æ˜Ÿé»„ç» + å²å·®ç§¯ç´¯(çº¦24åº¦ since ancient, but 0 since J2000 definition).
    // ç­‰ç­‰ï¼Œç”¨æˆ·ç»™çš„ XIU_DATA æ˜¯ J2000 åæ ‡ã€‚
    // æˆ‘ä»¬ç®—å‡ºçš„ sunLon æ˜¯ Date æ—¶çš„å›å½’é»„ç»ã€‚
    // å®ƒä»¬ä¹‹é—´çš„å·®å€¼æ˜¯ï¼š Ayanamsa (J2000). 
    // J2000 æ—¶ï¼Œæ˜¥åˆ†ç‚¹çº¦åœ¨ åŒé±¼åº§6åº¦ (æ’æ˜Ÿ). 
    // ç®€ä¾¿å¤„ç†ï¼šç›´æ¥å°† J2000 å®¿åº¦åœˆä¸ å›å½’é»„é“åœˆ å¯¹é½? 
    // ä¸ï¼Œå›å½’é»„é“åœ¨é£˜ç§»ã€‚æ’æ˜Ÿåœˆæ˜¯æ­»çš„ã€‚
    // å®ƒä»¬ä¹‹é—´çš„å¤¹è§’å·®å¼‚æ˜¯ï¼š (Date - 2000) * PrecessionRate.
    // 26å¹´ * 0.0139 = 0.36åº¦ã€‚å‡ ä¹çœ‹ä¸å‡ºæ¥ã€‚
    // ä½†é‡ç‚¹æ˜¯ï¼šå¤æ³•(å¯=æˆ¿) vs å®æµ‹.
    // æˆ‘ä»¬è¿™é‡Œå±•ç¤ºçš„æ˜¯ å®æµ‹(J2000).
    // æ‰€ä»¥å®¿åº¦åœˆç›¸å¯¹äºå›å½’åœˆï¼Œåªéœ€è¦åè½¬è¿™ 0.36åº¦ (å‡ ä¹åŒæ­¥)ã€‚
    // **ä¿®æ­£**ï¼šXIU_DATA æ˜¯ J2000 æ’æ˜Ÿåæ ‡ã€‚getSunLon æ˜¯å½“å‰å›å½’åæ ‡ã€‚
    // ä¸¤è€…å·®ä¸€ä¸ª Delta T çš„å²å·®ã€‚
    // è®©æˆ‘ä»¬å‡è®¾å®ƒä»¬é”å®šåœ¨ä¸€èµ· (å› ä¸ºè¯¯å·®å¾ˆå°)ï¼Œæˆ–è€…åšå¾®è°ƒã€‚
    // å®é™…ä¸Šï¼ŒJ2000çš„æ˜¥åˆ†ç‚¹(å›å½’0åº¦) å¯¹åº” æ’æ˜Ÿé»„ç» 0åº¦ (å®šä¹‰ä¸Š)? 
    // ä¸ï¼ŒJ2000 æ˜¥åˆ†ç‚¹å¯¹åº”æ’æ˜ŸåŒé±¼åº§ã€‚
    // ä¸ºäº†è®©å›¾è¡¨ç›´è§‚ï¼Œæˆ‘ä»¬è®©å®¿åº¦åœˆä¹Ÿå¯¹å‡†å¤ªé˜³ã€‚
    // å¤ªé˜³åœ¨ J2000 å®¿åº¦ä¸Šçš„ä½ç½® = SunLon(Tropical) - 0.01397*(Year-2000).
    const precession = 0.01397 * (utcTime.getFullYear() - 2000);
    const sunSiderealLon = sunLon - precession;
    
    // å®¿åº¦åœˆæ—‹è½¬ï¼šè®© sunSiderealLon å¯¹å‡† å¤ªé˜³æŒ‡é’ˆ
    const starRot = sunAngle - sunSiderealLon - 90;
    document.getElementById('dialStars').setAttribute('transform', `translate(150,150) rotate(${starRot})`);

    // 3. è®¡ç®—æœˆäº®æŒ‡é’ˆ
    const moonLon = getMoonData(utcTime); // å›å½’
    // æœˆäº®ç›¸å¯¹äºå¤ªé˜³çš„è§’åº¦ (ç›¸ä½è§’)
    // Sun=200, Moon=210. Diff = 10.
    // MoonPointer = SunPointer + 10 ? No.
    // Zodiac runs counter-clockwise.
    // If Moon > Sun, Moon is "Left" (East) of Sun on chart?
    // é’Ÿè¡¨é¡ºæ—¶é’ˆã€‚Zodiac é€†æ—¶é’ˆç”».
    // å¦‚æœ Sun=0(Top). Moon=30(Left?).
    // MoonPointer angle should be -30?
    // Let's verify: Sun resets at 24h. Moon moves slower (lags).
    // Moon Phase = MoonLon - SunLon.
    let phaseAngle = norm360(moonLon - sunLon);
    // åœ¨è¡¨ç›˜ä¸Šçš„å¤¹è§’ï¼šç”±äºè¡¨ç›˜æ˜¯ 12å°æ—¶=360åº¦ (24h mode).
    // ä¸ï¼Œè¿™æ˜¯ 24h ç½—ç›˜ã€‚
    // Sun moves 15 deg/hour.
    // Moon moves ~14.5 deg/hour (slower).
    // Geometric position:
    // We positioned Zodiac based on Sun.
    // So Moon Pointer just needs to point to MoonLon on that Zodiac.
    // MoonPointerRotation = ZodiacRotation + MoonLon + 90?
    // = (SunAngle - SunLon - 90) + MoonLon + 90
    // = SunAngle + (MoonLon - SunLon)
    // = SunAngle + PhaseAngle.
    // Wait, Zodiac is counter-clockwise. SVG rotation is clockwise.
    // If MoonLon = SunLon + 30.
    // Moon should be at SunAngle - 30 (CCW).
    
    const moonRot = sunAngle - phaseAngle; 
    document.getElementById('moonHand').setAttribute('transform', `translate(150,150) rotate(${moonRot})`);
    
    // 4. ç»˜åˆ¶æ˜¼å¤œæ‰‡åŒº
    const sunT = getSunTimes(utcTime, lat);
    if (sunT) {
        // sunT returns minutes from midnight (True Solar).
        // Convert to Angles. 12:00 = 0 deg.
        // 06:00 = 360 min = -90 deg.
        // 18:00 = 1080 min = +90 deg.
        // Formula: (min/60 - 12) * 15
        const riseAng = (sunT.rise/60 - 12) * 15;
        const setAng = (sunT.set/60 - 12) * 15;
        
        // æ‰‡åŒºï¼šä»æ—¥è½ åˆ° æ—¥å‡º (å¤œæ™š)
        // SVG Arc: Start (Set) -> End (Rise)
        // Convert to radians. SVG 0 is at 3 o'clock (90 deg in our dial).
        // Dial 0 (Top) is -90 in SVG.
        // So SVG Rad = (DialAng - 90) * D2R
        const startRad = (setAng - 90) * D2R;
        const endRad = (riseAng - 90) * D2R;
        
        // Day Sector (Rise -> Set)
        const dStart = (riseAng - 90) * D2R;
        const dEnd = (setAng - 90) * D2R;
        
        const r = 148;
        // Large arc flag
        const nightDiff = norm360(riseAng - setAng);
        const dayDiff = norm360(setAng - riseAng);
        
        const pathNight = describeArc(150, 150, r, setAng-90, riseAng-90);
        const pathDay = describeArc(150, 150, r, riseAng-90, setAng-90);
        
        document.getElementById('nightSector').setAttribute('d', pathNight);
        document.getElementById('daySector').setAttribute('d', pathDay);
        
        // æ›´æ–°é¢æ¿æ•°å€¼
        document.getElementById('valSunTimes').innerText = `${fmtMin(sunT.rise)} / ${fmtMin(sunT.set)}`;
    }
    
    // 5. æ›´æ–°æœˆç›¸å›¾æ ‡å½¢çŠ¶
    updateMoonIcon(phaseAngle);
    
    // 6. æ›´æ–°æ•°æ®é¢æ¿æ–‡å­— (å®«ä½ä¸æ˜Ÿå®¿)
    // å¤ªé˜³æ‰€åœ¨çš„å®«ä¸å®¿
    // æœˆäº®æ‰€åœ¨çš„å®«ä¸å®¿ (ç”¨æˆ·æ›´å…³å¿ƒæœˆäº®)
    const mZodiac = getZodiacName(moonLon);
    const mStar = getStarName(moonLon - precession);
    document.getElementById('valZodiac').innerText = `æœˆåœ¨ ${mZodiac}`;
    document.getElementById('valStar').innerText = `æœˆèº” ${mStar}`;
    
    // æœˆç›¸æ–‡å­—
    const phaseName = getPhaseName(phaseAngle);
    const pEl = document.getElementById('valPhase');
    pEl.innerHTML = phaseName;
    if (["æœ”","æœ›","ä¸Šå¼¦","ä¸‹å¼¦","æ™¦"].some(x=>phaseName.includes(x))) {
        pEl.classList.add('highlight-phase');
    } else {
        pEl.classList.remove('highlight-phase');
    }
}

// è¾…åŠ©ï¼šSVG æ‰‡åŒºè·¯å¾„ç”Ÿæˆ
function describeArc(x, y, radius, startAngle, endAngle){
    var start = polarToCartesian(x, y, radius, endAngle);
    var end = polarToCartesian(x, y, radius, startAngle);
    var largeArcFlag = endAngle - startAngle <= 180 ? "0" : "1";
    // å¦‚æœè·¨è¶Š 0/360ï¼Œä¿®æ­£
    if (endAngle < startAngle) largeArcFlag = (endAngle + 360 - startAngle) <= 180 ? "0" : "1";

    var d = [
        "M", x, y,
        "L", start.x, start.y,
        "A", radius, radius, 0, largeArcFlag, 0, end.x, end.y,
        "L", x, y // Close to center
    ].join(" ");
    return d;
}
function polarToCartesian(centerX, centerY, radius, angleInDegrees) {
  var angleInRadians = (angleInDegrees-90) * Math.PI / 180.0; // SVG -90 offset removed here? No, passed in pre-adjusted
  // Actually standard math: 0 is Right. 
  // We passed in (DialAng - 90). DialAng 0=Top. -90=Top.
  // Math cos(-90)=0, sin(-90)=-1. (0, -r). Correct.
  angleInRadians = angleInDegrees * Math.PI / 180.0;
  return {
    x: centerX + (radius * Math.cos(angleInRadians)),
    y: centerY + (radius * Math.sin(angleInRadians))
  };
}

// æ›´æ–°æœˆç›¸å›¾æ ‡ (SVG path)
function updateMoonIcon(phase) {
    // phase 0-360. 0=New, 90=First Q, 180=Full.
    // Draw a circle masking.
    // ç®€å•æ¨¡æ‹Ÿ: 
    // 0: Black. 180: White.
    // 90: Half right white.
    // ä½¿ç”¨ path d.
    // è¿™æ˜¯ä¸€ä¸ªå¤æ‚çš„å‡ ä½•é—®é¢˜ï¼Œä¸ºäº†æ€§èƒ½ï¼Œæˆ‘ä»¬ç®€åŒ–é¢œè‰²/é€æ˜åº¦?
    // æˆ–è€…åªç”» é˜´å½±éƒ¨åˆ†.
    // è¿™é‡Œç®€åŒ–ï¼šåªæ”¹é¢œè‰²æ— æ³•ä½“ç°å½¢çŠ¶ã€‚
    // ä½¿ç”¨ path æ¨¡æ‹Ÿ: M 0 -r A r r 0 0 1 0 r ... Bezier curve for shadow.
    // å¤ªéº»çƒ¦ï¼Œä¸ºäº†ç¨³å®šæ€§ï¼Œä»…æ”¹å˜é€æ˜åº¦/é¢œè‰²?
    // ä¸ï¼Œç”¨æˆ·è¦æ±‚"ç‰¹æ®Šé¢œè‰²æˆ–æ ‡å¿—".
    // æˆ‘ä»¬å¯ä»¥æ ¹æ® phase æ›´æ”¹ moonPhaseShape çš„ d
    // æç®€å®ç°: 
    const r = 5;
    let path = "";
    // New (0) -> Full (180) -> New (360)
    // ç®€åŒ–ç‰ˆï¼šä½¿ç”¨ emoji æˆ– ç®€å•çš„åœ†å½¢å¡«å……æ¯”ä¾‹
    // è®©æˆ‘ä»¬ç”»ä¸€ä¸ªç®€å•çš„åœ†ï¼Œé€šè¿‡æ”¹å˜ fill-opacity æ¨¡æ‹Ÿäº®åº¦
    // å®å¿ƒåœ† path
    const shape = document.getElementById('moonPhaseShape');
    // å¦‚æœæ˜¯æœ”/æ™¦(New)ï¼Œç”»ç©ºå¿ƒ? 
    if (phase < 5 || phase > 355) { // New
        shape.setAttribute('d', `M -${r} 0 A ${r} ${r} 0 1 1 ${r} 0 A ${r} ${r} 0 1 1 -${r} 0`); // Full circle
        shape.setAttribute('fill', '#000'); // Black
        shape.setAttribute('stroke', '#00ccff');
    } else if (Math.abs(phase - 180) < 5) { // Full
        shape.setAttribute('d', `M -${r} 0 A ${r} ${r} 0 1 1 ${r} 0 A ${r} ${r} 0 1 1 -${r} 0`);
        shape.setAttribute('fill', '#ffcc00'); // Yellow/White
        shape.setAttribute('stroke', 'none');
    } else {
        // Quarter / Crescent
        // Just fill blue default
        shape.setAttribute('d', `M -${r} 0 A ${r} ${r} 0 1 1 ${r} 0 A ${r} ${r} 0 1 1 -${r} 0`);
        shape.setAttribute('fill', '#00ccff');
        shape.setAttribute('stroke', 'none');
        // Calculate lighting width... skipped for performance, sticking to color coding text
    }
}

// === è¾…åŠ©æŸ¥è¯¢å‡½æ•° ===
function getZodiacName(lon) {
    // lon 0-360 (Aries 0)
    // ZODIAC_GONGS: 0=Xu, 30=You... (This is LiuRen mapping, distinct from standard Order)
    // Standard Tropical: 0=Aries, 30=Taurus...
    // User wants "Mao = Scorpio". 
    // Scorpio is 210-240.
    // Check ZODIAC_GONGS data: {n:"å¯/å¤©è", d:210}
    for (let z of ZODIAC_GONGS) {
        if (lon >= z.d && lon < z.d+30) return z.n;
    }
    return "æœªçŸ¥";
}

function getStarName(siderealLon) {
    let l = norm360(siderealLon);
    // Find interval
    let sorted = [...XIU_DATA].sort((a,b)=>a.d-b.d);
    // Handle Bi (5.1) wrapping
    // å®é™…ä¸Š 348.6(å®¤) -> 5.1(å£) -> 10.5(å¥)
    // Range for Bi is 5.1 to 10.5 ? No, start at 5.1.
    // Range for Shi is 348.6 to 5.1 (cross 0).
    
    for (let i=0; i<sorted.length; i++) {
        let curr = sorted[i];
        let next = sorted[(i+1)%sorted.length];
        
        let start = curr.d;
        let end = next.d;
        if (end < start) end += 360;
        
        let checkL = l;
        if (checkL < start && (start-checkL)>180) checkL+=360;
        
        if (checkL >= start && checkL < end) {
            let deg = Math.floor(checkL - start);
            return `${curr.n}å®¿ ${deg}Â°`;
        }
    }
    return "--";
}

function getPhaseName(deg) {
    // 0=New, 90=First, 180=Full, 270=Last
    if (deg < 2 || deg > 358) return "ğŸŒ‘ æœ” (New)";
    if (deg > 355 || deg < 5) return "ğŸŒ‘ æ™¦ (Dark)"; // å®é™…ä¸Šæ™¦æ˜¯30æ—¥ï¼Œæœ”æ˜¯åˆä¸€
    if (Math.abs(deg - 90) < 5) return "ğŸŒ“ ä¸Šå¼¦ (1st Q)";
    if (Math.abs(deg - 180) < 5) return "ğŸŒ• æœ› (Full)";
    if (Math.abs(deg - 270) < 5) return "ğŸŒ— ä¸‹å¼¦ (3rd Q)";
    
    // ä¸­é—´çŠ¶æ€
    const age = (deg / 360) * 29.53;
    return `å†œå†${Math.floor(age)+1}æ—¥ (Age:${age.toFixed(1)})`;
}

// æ ¼å¼åŒ–å‡½æ•°
function pad(n) { return n.toString().padStart(2,'0'); }
function fmtMin(totalM) {
    let tm = norm360(totalM/15*60/60*15); // messy normalization
    // totalM is minutes from 00:00
    // handle negative
    while(totalM < 0) totalM += 1440;
    while(totalM >= 1440) totalM -= 1440;
    let h = Math.floor(totalM/60);
    let m = Math.floor(totalM%60);
    return `${pad(h)}:${pad(m)}`;
}
function updateDataPanel(trueTime, utcTime) {
    document.getElementById('valLoc').innerText = `Lon:${APP.lon.toFixed(2)} Lat:${APP.lat.toFixed(2)}`;
    // Diff
    const diffM = (trueTime - utcTime) / 60000;
    const sign = diffM >= 0 ? "+" : "-";
    const abs = Math.abs(diffM);
    document.getElementById('valDiff').innerText = `Diff: ${sign}${Math.floor(abs)}m${Math.floor((abs%1)*60)}s`;
}

// === äº¤äº’é€»è¾‘ ===
function togglePause() {
    APP.paused = !APP.paused;
    const b = document.getElementById('mainDisplay');
    const btn = document.getElementById('pauseBtn');
    
    if (APP.paused) {
        APP.frozenTime = new Date(APP.baseTime); // é”å®šå½“å‰è®¡ç®—åŸºå‡†
        b.classList.add('paused');
        btn.innerText = "â–¶";
    } else {
        b.classList.remove('paused');
        btn.innerText = "â¸";
        // æ¢å¤æ—¶ï¼ŒbaseTime ä¼šåœ¨ update ä¸­è‡ªåŠ¨è·³åˆ°å½“å‰ new Date()
    }
}

function toggleMode() {
    const p = document.getElementById('manualPanel');
    const b = document.getElementById('modeBtn');
    if (APP.mode === 'gps') {
        APP.mode = 'manual';
        p.classList.add('show');
        b.innerText = "å½“å‰ï¼šæ‰‹åŠ¨/éªŒè¯æ¨¡å¼ (ç‚¹æ­¤åˆ‡å› GPS)";
        // åˆå§‹åŒ–æ‰‹åŠ¨æ—¶é—´ä¸ºå½“å‰
        if (!APP.paused) APP.manualOffset = 0;
    } else {
        APP.mode = 'gps';
        p.classList.remove('show');
        b.innerText = "åˆ‡æ¢ï¼šæ‰‹åŠ¨/éªŒè¯æ¨¡å¼";
        APP.paused = false; // åˆ‡å›GPSè‡ªåŠ¨ç»§ç»­
        document.getElementById('mainDisplay').classList.remove('paused');
        document.getElementById('pauseBtn').innerText = "â¸";
        initGPS();
    }
}

function applyManual() {
    const tVal = document.getElementById('manualTime').value;
    const lonVal = parseFloat(document.getElementById('manualLon').value);
    const latVal = parseFloat(document.getElementById('manualLat').value);
    
    if (tVal) {
        const target = new Date(tVal);
        const now = new Date();
        APP.manualOffset = target - now;
        // å¦‚æœæƒ³è¦"å®šæ ¼"åœ¨è¾“å…¥çš„æ—¶é—´ï¼Œå¯ä»¥è‡ªåŠ¨æš‚åœ
        APP.paused = true;
        APP.frozenTime = target; // ç«‹å³é”å®š
        document.getElementById('mainDisplay').classList.add('paused');
        document.getElementById('pauseBtn').innerText = "â–¶";
    }
    if (!isNaN(lonVal)) APP.lon = lonVal;
    if (!isNaN(latVal)) APP.lat = latVal;
}

function setNow() {
    const now = new Date();
    // ä¿®æ­£æ—¶åŒºåç§»ä»¥æ˜¾ç¤ºåœ¨ datetime-local
    const tzOffset = now.getTimezoneOffset() * 60000;
    const localISOTime = (new Date(now - tzOffset)).toISOString().slice(0, -1);
    document.getElementById('manualTime').value = localISOTime.slice(0,16); // yyyy-MM-ddThh:mm
    APP.manualOffset = 0;
    APP.paused = false;
    document.getElementById('mainDisplay').classList.remove('paused');
    document.getElementById('pauseBtn').innerText = "â¸";
}

// GPS
function initGPS() {
    if ("geolocation" in navigator) {
        navigator.geolocation.watchPosition(
            (pos) => {
                if (APP.mode !== 'gps') return;
                APP.lat = pos.coords.latitude;
                APP.lon = pos.coords.longitude;
                document.getElementById('gpsStatus').innerText = `GPS: é”å®š (Â±${Math.round(pos.coords.accuracy)}m)`;
                document.getElementById('gpsStatus').style.color = "var(--main-color)";
            },
            (err) => {
                if (APP.mode !== 'gps') return;
                document.getElementById('gpsStatus').innerText = "GPS: å¤±æ•ˆ (é»˜è®¤åŒ—äº¬)";
                document.getElementById('gpsStatus').style.color = "#666";
            },
            {enableHighAccuracy:true}
        );
    }
}

// å¯åŠ¨
initSVG();
initGPS();
setNow();
update();

</script>
</body>
</html>
