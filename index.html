<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Astro Terminal V8</title>
    <style>
        :root {
            --bg: #000000;
            --card-bg: #0b0b0b;
            --border: #333;
            --text-main: #e0e0e0;
            --text-dim: #666;
            
            /* æˆ˜æœ¯è‰²æ¿ */
            --time-color: #00ff41; 
            --sun-color: #ffcc00;
            --moon-color: #00ccff;
            --alert: #ff3333;
            
            /* äº”è¡Œçº³éŸ³è‰² */
            --el-wood: #4caf50; /* æœ¨-ç»¿ */
            --el-fire: #ff5252; /* ç«-çº¢ */
            --el-earth: #d7ccc8; /* åœŸ-è¤/ç° */
            --el-metal: #ffd700; /* é‡‘-é»„/ç™½ */
            --el-water: #40c4ff; /* æ°´-è“ */
        }

        body {
            background-color: var(--bg);
            color: var(--text-main);
            font-family: "Menlo", "Consolas", monospace;
            margin: 0;
            padding: 10px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
            user-select: none;
        }

        /* 1. é¡¶éƒ¨æ  */
        .header {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: var(--text-dim);
            margin-bottom: 15px;
            border-bottom: 1px solid #222;
            padding-bottom: 5px;
        }
        .gps-active { color: var(--time-color); }
        .btn-set { background:none; border:none; color:#888; cursor:pointer; font-family:inherit; }

        /* 2. Hero Time (çœŸå¤ªé˜³æ—¶) */
        .hero-section { text-align: center; margin-bottom: 25px; }
        .true-time {
            font-size: 3.2rem;
            font-weight: 300;
            color: var(--time-color);
            line-height: 1;
            letter-spacing: -1px;
            font-variant-numeric: tabular-nums;
        }
        .std-info { font-size: 0.85rem; color: #888; margin-top: 5px; }
        .badge { 
            font-size: 0.7rem; background:#111; border:1px solid #333; 
            padding:1px 4px; border-radius:3px; vertical-align:middle; 
        }
        .paused-state { color: var(--alert); border-color: var(--alert); }

        /* 3. ç½‘æ ¼å¸ƒå±€ */
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            width: 100%;
        }
        @media(min-width: 700px) { .grid { grid-template-columns: repeat(4, 1fr); } }

        /* å¡ç‰‡é€šç”¨ */
        .card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            padding: 10px;
            border-radius: 4px;
            display: flex;
            flex-direction: column;
        }
        .c-full { grid-column: 1 / -1; }
        .c-title { font-size: 10px; color: var(--text-dim); text-transform: uppercase; margin-bottom: 6px; letter-spacing: 1px;}
        
        /* 4. å¹²æ”¯å››æŸ± (ç«–æ’) */
        .bz-container {
            display: flex;
            justify-content: space-around;
            text-align: center;
        }
        .bz-col {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            font-size: 16px;
            font-weight: bold;
        }
        .nayin {
            font-size: 10px;
            margin-top: 4px;
            font-weight: normal;
            writing-mode: vertical-rl; /* ç«–æ’æ–‡å­— */
            letter-spacing: 2px;
        }
        /* çº³éŸ³é¢œè‰²ç±» */
        .ny-é‡‘ { color: var(--el-metal); }
        .ny-æœ¨ { color: var(--el-wood); }
        .ny-æ°´ { color: var(--el-water); }
        .ny-ç« { color: var(--el-fire); }
        .ny-åœŸ { color: var(--el-earth); }

        /* 5. æ—¶è¾°æ§åˆ¶å° */
        .ctrl-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: auto;
            padding-top: 10px;
            border-top: 1px dashed #222;
        }
        .shichen-main { font-size: 18px; color: var(--sun-color); font-weight: bold; }
        .shichen-sub { font-size: 12px; color: #888; }
        .btn-ctrl {
            background: #1a1a1a; border: 1px solid #333; color: #ccc;
            padding: 4px 10px; font-size: 12px; cursor: pointer; border-radius: 3px;
        }
        .btn-ctrl:active { background: var(--time-color); color:#000; }
        .play-btn { width: 60px; text-align: center; }

        /* 6. å¤©æ–‡æ•°æ®è¡Œ */
        .astro-row {
            display: flex; justify-content: space-between; align-items: center;
            font-size: 13px; margin-bottom: 4px;
        }
        .astro-val { font-weight: bold; }
        .astro-deg { font-family: monospace; color: #aaa; font-size: 12px; }
        .bar-bg { height: 3px; background: #222; width: 100%; margin-top: 2px; border-radius: 2px; }
        .bar-fill { height: 100%; background: #444; border-radius: 2px; }

        /* 7. é¢„æŠ¥å°å­— */
        .forecast { font-size: 11px; color: #555; margin-top: 4px; }

        /* å¼¹çª—è®¾ç½® */
        .modal {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.9);
            display: none; align-items: center; justify-content: center; z-index: 999;
        }
        .modal-box { background: #111; border: 1px solid #444; padding: 20px; width: 280px; }
        .ipt-group { margin-bottom: 10px; }
        .ipt-group label { display: block; font-size: 11px; color: #888; margin-bottom: 3px; }
        .ipt-group input { 
            width: 100%; background: #000; border: 1px solid #333; 
            color: #fff; padding: 6px; box-sizing: border-box;
        }
        .btn-full { width: 100%; padding: 8px; background: #222; color: #fff; border: 1px solid #444; cursor: pointer; }

    </style>
</head>
<body>

    <div class="header">
        <span id="gpsInd">GPS: åˆå§‹åŒ–...</span>
        <button class="btn-set" onclick="APP.openSet()">[è®¾ç½®]</button>
    </div>

    <div class="hero-section">
        <div class="true-time" id="dispTrue">00:00:00</div>
        <div class="std-info">
            <span id="dispStd">STD 00:00:00</span>
            <span class="badge" id="dispDiff">Diff --</span>
            <span class="badge" id="pauseTag" style="display:none">PAUSED</span>
        </div>
    </div>

    <div class="grid">
        
        <div class="card c-full">
            <div class="c-title">Four Pillars (å¹²æ”¯å…«å­—)</div>
            <div class="bz-container">
                <div class="bz-col">
                    <span id="bzY">--</span>
                    <span class="nayin" id="nyY">--</span>
                </div>
                <div class="bz-col">
                    <span id="bzM">--</span>
                    <span class="nayin" id="nyM">--</span>
                </div>
                <div class="bz-col">
                    <span id="bzD">--</span>
                    <span class="nayin" id="nyD">--</span>
                </div>
                <div class="bz-col">
                    <span id="bzH">--</span>
                    <span class="nayin" id="nyH">--</span>
                </div>
            </div>
        </div>

        <div class="card c-full">
            <div class="c-title">Chronometer Control</div>
            <div class="shichen-main" id="valShichen">--æ—¶ --åˆ»</div>
            <div class="shichen-sub" id="valNextKe">è·ç¦»ä¸‹åˆ»: --åˆ†</div>
            
            <div class="ctrl-row">
                <button class="btn-ctrl" onclick="APP.jump(-1)">-1H</button>
                <button class="btn-ctrl play-btn" onclick="APP.togglePause()" id="btnPlay">æš‚åœ</button>
                <button class="btn-ctrl" onclick="APP.reset()">å¤ä½</button>
                <button class="btn-ctrl" onclick="APP.jump(1)">+1H</button>
            </div>
        </div>

        <div class="card c-full">
            <div class="c-title">Tropical Zodiac (å›å½’é»„é“ - æ°”)</div>
            <div class="astro-row">
                <span style="color:var(--sun-color)">â˜€ å¤ªé˜³</span>
                <span class="astro-val" id="sunTropName">--</span>
                <span class="astro-deg" id="sunTropDeg">--/30Â°</span>
            </div>
            <div class="bar-bg"><div class="bar-fill" id="barSunTrop" style="background:var(--sun-color)"></div></div>
            <div style="height:8px"></div>
            <div class="astro-row">
                <span style="color:var(--moon-color)">â˜¾ æœˆäº®</span>
                <span class="astro-val" id="moonTropName">--</span>
                <span class="astro-deg" id="moonTropDeg">--/30Â°</span>
            </div>
            <div class="bar-bg"><div class="bar-fill" id="barMoonTrop" style="background:var(--moon-color)"></div></div>
        </div>

        <div class="card c-full">
            <div class="c-title">Sidereal Mansions (æ’æ˜Ÿå®¿åº¦ - è´¨)</div>
            <div class="astro-row">
                <span style="color:#aaa">â˜€ å¤ªé˜³</span>
                <span class="astro-val" id="sunSidName">--</span>
                <span class="astro-deg" id="sunSidDeg">--</span>
            </div>
            <div style="height:8px"></div>
            <div class="astro-row">
                <span style="color:#fff">â˜¾ æœˆäº®</span>
                <span class="astro-val" id="moonSidName">--</span>
                <span class="astro-deg" id="moonSidDeg">--</span>
            </div>
        </div>

        <div class="card">
            <div class="c-title">Moon Phase</div>
            <div class="astro-val" id="valPhase" style="font-size:14px">--</div>
            <div class="forecast" id="nextPhase">--</div>
        </div>

        <div class="card">
            <div class="c-title">Void of Course (Lilly)</div>
            <div class="astro-val" id="valVoc" style="font-size:14px">--</div>
            <div class="forecast" id="nextVoc">--</div>
        </div>
        
        <div class="card c-full">
            <div class="c-title">Location</div>
            <div style="display:flex; justify-content:space-between; font-size:12px;">
                <span id="valLoc">--</span>
                <span id="valEoT">EoT: --</span>
            </div>
        </div>

    </div>

    <div class="modal" id="modalSet">
        <div class="modal-box">
            <div class="ipt-group"><label>æ—¥æœŸæ—¶é—´</label><input type="datetime-local" id="iptTime" step="1"></div>
            <div class="ipt-group"><label>ç»åº¦ (E+)</label><input type="number" id="iptLon"></div>
            <div class="ipt-group"><label>çº¬åº¦ (N+)</label><input type="number" id="iptLat"></div>
            <button class="btn-full" onclick="APP.applySet()">ç¡®è®¤ä¿®æ”¹</button>
            <button class="btn-full" onclick="APP.closeSet()" style="margin-top:5px; background:none; border:none;">å–æ¶ˆ</button>
        </div>
    </div>

<script>
/**
 * ASTRO TERMINAL V8.0
 * Features: Fixed Time Engine, NaYin Color, Dual Zodiac, Full Data
 */

// === 1. æ•°æ®å¸¸é‡ ===
const PI = Math.PI, D2R = PI/180, R2D = 180/PI;
const ZODIAC = ["ç™½ç¾Š","é‡‘ç‰›","åŒå­","å·¨èŸ¹","ç‹®å­","å¤„å¥³","å¤©ç§¤","å¤©è","å°„æ‰‹","æ‘©ç¾¯","æ°´ç“¶","åŒé±¼"];
const GAN = ["ç”²","ä¹™","ä¸™","ä¸","æˆŠ","å·±","åºš","è¾›","å£¬","ç™¸"];
const ZHI = ["å­","ä¸‘","å¯…","å¯","è¾°","å·³","åˆ","æœª","ç”³","é…‰","æˆŒ","äº¥"];
const KE = ["åˆåˆ»","ä¸€åˆ»","äºŒåˆ»","ä¸‰åˆ»","å››åˆ»","äº”åˆ»","å…­åˆ»","ä¸ƒåˆ»"];

// çº³éŸ³è¡¨ (Key:å¹²æ”¯, Val:{n:çº³éŸ³å, e:äº”è¡Œ})
const NAYIN = {
    "ç”²å­":{n:"æµ·ä¸­é‡‘",e:"é‡‘"},"ä¹™ä¸‘":{n:"æµ·ä¸­é‡‘",e:"é‡‘"},"ä¸™å¯…":{n:"ç‚‰ä¸­ç«",e:"ç«"},"ä¸å¯":{n:"ç‚‰ä¸­ç«",e:"ç«"},
    "æˆŠè¾°":{n:"å¤§æ—æœ¨",e:"æœ¨"},"å·±å·³":{n:"å¤§æ—æœ¨",e:"æœ¨"},"åºšåˆ":{n:"è·¯æ—åœŸ",e:"åœŸ"},"è¾›æœª":{n:"è·¯æ—åœŸ",e:"åœŸ"},
    "å£¬ç”³":{n:"å‰‘é”‹é‡‘",e:"é‡‘"},"ç™¸é…‰":{n:"å‰‘é”‹é‡‘",e:"é‡‘"},"ç”²æˆŒ":{n:"å±±å¤´ç«",e:"ç«"},"ä¹™äº¥":{n:"å±±å¤´ç«",e:"ç«"},
    "ä¸™å­":{n:"æ¶§ä¸‹æ°´",e:"æ°´"},"ä¸ä¸‘":{n:"æ¶§ä¸‹æ°´",e:"æ°´"},"æˆŠå¯…":{n:"åŸå¤´åœŸ",e:"åœŸ"},"å·±å¯":{n:"åŸå¤´åœŸ",e:"åœŸ"},
    "åºšè¾°":{n:"ç™½èœ¡é‡‘",e:"é‡‘"},"è¾›å·³":{n:"ç™½èœ¡é‡‘",e:"é‡‘"},"å£¬åˆ":{n:"æ¨æŸ³æœ¨",e:"æœ¨"},"ç™¸æœª":{n:"æ¨æŸ³æœ¨",e:"æœ¨"},
    "ç”²ç”³":{n:"æ³‰ä¸­æ°´",e:"æ°´"},"ä¹™é…‰":{n:"æ³‰ä¸­æ°´",e:"æ°´"},"ä¸™æˆŒ":{n:"å±‹ä¸ŠåœŸ",e:"åœŸ"},"ä¸äº¥":{n:"å±‹ä¸ŠåœŸ",e:"åœŸ"},
    "æˆŠå­":{n:"éœ¹é›³ç«",e:"ç«"},"å·±ä¸‘":{n:"éœ¹é›³ç«",e:"ç«"},"åºšå¯…":{n:"æ¾æŸæœ¨",e:"æœ¨"},"è¾›å¯":{n:"æ¾æŸæœ¨",e:"æœ¨"},
    "å£¬è¾°":{n:"é•¿æµæ°´",e:"æ°´"},"ç™¸å·³":{n:"é•¿æµæ°´",e:"æ°´"},"ç”²åˆ":{n:"æ²™ä¸­é‡‘",e:"é‡‘"},"ä¹™æœª":{n:"æ²™ä¸­é‡‘",e:"é‡‘"},
    "ä¸™ç”³":{n:"å±±ä¸‹ç«",e:"ç«"},"ä¸é…‰":{n:"å±±ä¸‹ç«",e:"ç«"},"æˆŠæˆŒ":{n:"å¹³åœ°æœ¨",e:"æœ¨"},"å·±äº¥":{n:"å¹³åœ°æœ¨",e:"æœ¨"},
    "åºšå­":{n:"å£ä¸ŠåœŸ",e:"åœŸ"},"è¾›ä¸‘":{n:"å£ä¸ŠåœŸ",e:"åœŸ"},"å£¬å¯…":{n:"é‡‘ç®”é‡‘",e:"é‡‘"},"ç™¸å¯":{n:"é‡‘ç®”é‡‘",e:"é‡‘"},
    "ç”²è¾°":{n:"è¦†ç¯ç«",e:"ç«"},"ä¹™å·³":{n:"è¦†ç¯ç«",e:"ç«"},"ä¸™åˆ":{n:"å¤©æ²³æ°´",e:"æ°´"},"ä¸æœª":{n:"å¤©æ²³æ°´",e:"æ°´"},
    "æˆŠç”³":{n:"å¤§é©¿åœŸ",e:"åœŸ"},"å·±é…‰":{n:"å¤§é©¿åœŸ",e:"åœŸ"},"åºšæˆŒ":{n:"é’—é’é‡‘",e:"é‡‘"},"è¾›äº¥":{n:"é’—é’é‡‘",e:"é‡‘"},
    "å£¬å­":{n:"æ¡‘æŸ˜æœ¨",e:"æœ¨"},"ç™¸ä¸‘":{n:"æ¡‘æŸ˜æœ¨",e:"æœ¨"},"ç”²å¯…":{n:"å¤§æºªæ°´",e:"æ°´"},"ä¹™å¯":{n:"å¤§æºªæ°´",e:"æ°´"},
    "ä¸™è¾°":{n:"æ²™ä¸­åœŸ",e:"åœŸ"},"ä¸å·³":{n:"æ²™ä¸­åœŸ",e:"åœŸ"},"æˆŠåˆ":{n:"å¤©ä¸Šç«",e:"ç«"},"å·±æœª":{n:"å¤©ä¸Šç«",e:"ç«"},
    "åºšç”³":{n:"çŸ³æ¦´æœ¨",e:"æœ¨"},"è¾›é…‰":{n:"çŸ³æ¦´æœ¨",e:"æœ¨"},"å£¬æˆŒ":{n:"å¤§æµ·æ°´",e:"æ°´"},"ç™¸äº¥":{n:"å¤§æµ·æ°´",e:"æ°´"}
};

// J2000 å®¿åº¦ (è§œåœ¨å‚å‰)
const XIU = [
    {n:"è§’",d:201.2}, {n:"äº¢",d:212.3}, {n:"æ°",d:221.7}, {n:"æˆ¿",d:238.6},
    {n:"å¿ƒ",d:244.7}, {n:"å°¾",d:252.0}, {n:"ç®•",d:268.3}, {n:"æ–—",d:277.6},
    {n:"ç‰›",d:302.3}, {n:"å¥³",d:309.8}, {n:"è™š",d:321.2}, {n:"å±",d:331.0},
    {n:"å®¤",d:348.6}, {n:"å£",d:5.1},   {n:"å¥",d:10.5},  {n:"å¨„",d:24.5},
    {n:"èƒƒ",d:37.8},  {n:"æ˜´",d:52.3},  {n:"æ¯•",d:61.2},  
    {n:"è§œ",d:76.8},  {n:"å‚",d:77.8}, 
    {n:"äº•",d:88.6},  {n:"é¬¼",d:120.5}, {n:"æŸ³",d:124.9},
    {n:"æ˜Ÿ",d:139.3}, {n:"å¼ ",d:147.2}, {n:"ç¿¼",d:164.7}, {n:"è½¸",d:184.4}
];

// === 2. çŠ¶æ€å¼•æ“ ===
const STATE = {
    mode: 'auto',  // 'auto' = SysTime, 'manual' = Simulated
    paused: false,
    baseTime: new Date(), // å½“å‰æ˜¾ç¤ºçš„é€»è¾‘æ—¶é—´
    lastTick: Date.now(), // ä¸Šä¸€å¸§çš„çœŸå®æ—¶é—´
    lat: 39.9042, 
    lon: 116.4074
};

// === 3. åŸºç¡€å‡½æ•°åº“ ===
function toRad(d) { return d * D2R; }
function norm360(d) { return (d % 360 + 360) % 360; }
function pad(n) { return n.toString().padStart(2,'0'); }
function julian(date) { return (date.getTime() / 86400000) + 2440587.5; }

// å®Œæ•´æ—¥æœŸæ ¼å¼ (MM-DD HH:MM)
function fmtFull(d) {
    return `${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
}

// ç®€æ˜“æ˜Ÿå†
function getPlanetLon(jd, body) {
    const T = (jd - 2451545.0) / 36525.0;
    let L=0, M=0;
    if (body==='sun') {
        L = 280.466 + 36000.770*T; M = 357.529 + 35999.050*T;
        return norm360(L + 1.915*Math.sin(toRad(M)) + 0.020*Math.sin(toRad(2*M)));
    }
    if (body==='moon') {
        L = 218.316 + 481267.881*T; M = 134.963 + 477198.867*T;
        return norm360(L + 6.289*Math.sin(toRad(M)));
    }
    // è¡Œæ˜Ÿ for VOC
    if (body==='mercury') return norm360(252.25 + 149472.66*T);
    if (body==='venus')   return norm360(181.98 + 58517.81*T);
    if (body==='mars')    return norm360(355.43 + 19140.29*T);
    if (body==='jupiter') return norm360(34.35 + 3034.90*T);
    if (body==='saturn')  return norm360(50.08 + 1222.11*T);
    return 0;
}

function getEoT(jd) {
    const T = (jd - 2451545.0)/36525.0;
    const M = toRad(357.529 + 35999.05*T);
    const L = toRad(280.466 + 36000.77*T);
    const e = 0.0167; const y = Math.tan(toRad(23.44)/2)**2;
    return (y*Math.sin(2*L) - 2*e*Math.sin(M) + 4*e*y*Math.sin(M)*Math.cos(2*L)) * R2D * 4;
}

// === 4. é«˜çº§æ’ç›˜é€»è¾‘ ===

// å¹²æ”¯è®¡ç®— (ç®€åŒ–ç‰ˆ - å®é™…é¡¹ç›®åº”æŸ¥è¡¨)
function getGanZhi(date, sunLon) {
    const y = date.getFullYear();
    // ç²—ç•¥ç«‹æ˜¥åˆ†ç•Œ
    let gzY = y;
    if (sunLon > 270 && sunLon < 315) gzY = y - 1; // è¿˜æ²¡åˆ°ç«‹æ˜¥
    let yIdx = (gzY - 1984 + 12000) % 60; // 1984ç”²å­
    
    // æœˆæŸ± (åŸºäºèŠ‚æ°”)
    // å¯…æœˆ(2) start at 315.
    let mBranch = Math.floor(norm360(sunLon - 315 + 360) / 30) + 2;
    if(mBranch > 11) mBranch -= 12;
    // äº”è™é
    let yStem = yIdx % 10;
    let mStemBase = (yStem % 5) * 2 + 2; // ç”²å·±ä¹‹å¹´ä¸™ä½œé¦–(2)
    let mStem = (mStemBase + (mBranch - 2 + 12)%12) % 10;
    
    // æ—¥æŸ± (JD)
    const jd = julian(date);
    // 2000-01-01 (JD 2451544.5) æ˜¯ æˆŠåˆ(54)
    let dIdx = Math.floor(jd - 2451544.5 + 54 + 0.5) % 60;
    
    // æ—¶æŸ±
    let hBranch = Math.floor((date.getHours() + 1)/2) % 12;
    // äº”é¼ é
    let dStem = dIdx % 10;
    let hStemBase = (dStem % 5) * 2; // ç”²å·±è¿˜åŠ ç”²
    let hStem = (hStemBase + hBranch) % 10;
    
    return [
        GAN[yIdx%10] + ZHI[yIdx%12], // Y
        GAN[mStem] + ZHI[mBranch],   // M
        GAN[dIdx%10] + ZHI[dIdx%12], // D
        GAN[hStem] + ZHI[hBranch]    // H
    ];
}

// æ’æ˜Ÿå®¿åº¦æŸ¥æ‰¾ (è¿”å›: å®¿å, å…¥å®¿åº¦, æ€»å¹¿åº¦)
function getSiderealInfo(lonTropical) {
    const precess = 24.5 + (STATE.baseTime.getFullYear()-2000)*0.01397; // åŠ¨æ€å²å·®
    const lonSid = norm360(lonTropical - precess);
    
    for(let i=0; i<XIU.length; i++) {
        let curr = XIU[i], next = XIU[(i+1)%XIU.length];
        let s = curr.d, e = next.d;
        if(e < s) e+=360;
        let v = lonSid;
        if(v < s && (s-v)>180) v+=360;
        
        if(v >= s && v < e) {
            return {
                name: curr.n,
                deg: (v-s).toFixed(1),
                total: (e-s).toFixed(1)
            };
        }
    }
    return {name:"?", deg:0, total:0};
}

// å¨å»‰åˆ©åˆ©ç©ºäº¡
function getVoc(jd) {
    const m = getPlanetLon(jd,'moon');
    const start = Math.floor(m/30)*30;
    const end = start + 30;
    const planets = ['sun','mercury','venus','mars','jupiter','saturn'].map(p=>getPlanetLon(jd,p));
    let isVoc = true;
    for(let p of planets) {
        for(let a of [0,60,90,120,180]) {
            let pts = [norm360(p+a), norm360(p-a)];
            for(let pt of pts) {
                let dist = norm360(pt - m);
                let toBorder = norm360(end - m);
                if(end===360 && m>330) toBorder = 360-m;
                if(toBorder===0) toBorder=30;
                if(dist>0.5 && dist<toBorder) { isVoc=false; break;}
            }
        }
    }
    return isVoc;
}

// é¢„æµ‹ä¸‹ä¸€ä¸ªäº‹ä»¶æ—¶é—´
function predictEvent(startJd, checkFn, targetVal) {
    let curr = startJd;
    let step = 10/1440.0; // 10 min
    for(let i=0; i<300; i++) { // search 2 days
        curr += step;
        if(checkFn(curr) === targetVal) {
            return new Date((curr - 2440587.5)*86400000);
        }
    }
    return null;
}

// === 5. ä¸»å¾ªç¯ ===
function update() {
    const nowReal = Date.now();
    const dt = nowReal - STATE.lastTick;
    STATE.lastTick = nowReal;

    // æ—¶é—´å¼•æ“æ ¸å¿ƒï¼š
    // å¦‚æœæ˜¯ Autoï¼Œç›´æ¥å– new Date()
    // å¦‚æœæ˜¯ Manual ä¸” !Pausedï¼Œç´¯åŠ  dt
    // å¦‚æœæ˜¯ Pausedï¼Œæ—¶é—´é™æ­¢
    if (STATE.mode === 'auto') {
        STATE.baseTime = new Date();
    } else if (!STATE.paused) {
        STATE.baseTime = new Date(STATE.baseTime.getTime() + dt);
    }

    const now = STATE.baseTime;
    const jd = julian(now);
    
    // å¤©æ–‡è®¡ç®—
    const sunLon = getPlanetLon(jd, 'sun');
    const moonLon = getPlanetLon(jd, 'moon');
    const eot = getEoT(jd);
    
    // çœŸå¤ªé˜³æ—¶
    const offMin = (STATE.lon - 120)*4;
    const trueMs = now.getTime() + (offMin + eot)*60000;
    const tTime = new Date(trueMs);
    
    // --- æ¸²æŸ“ UI ---
    
    // 1. æ—¶é—´æ˜¾ç¤º
    document.getElementById('dispTrue').innerText = 
        `${pad(tTime.getHours())}:${pad(tTime.getMinutes())}:${pad(tTime.getSeconds())}`;
    document.getElementById('dispStd').innerText = 
        `STD ${pad(now.getHours())}:${pad(now.getMinutes())}:${pad(now.getSeconds())}`;
    
    const diff = Math.round(offMin + eot);
    document.getElementById('dispDiff').innerText = `Diff ${diff>=0?'+':''}${diff}m`;

    const btnPlay = document.getElementById('btnPlay');
    const tagPause = document.getElementById('pauseTag');
    if(STATE.paused) {
        btnPlay.innerText = "ç»§ç»­";
        btnPlay.style.color = "var(--time-color)";
        tagPause.style.display = "inline-block";
        tagPause.className = "badge paused-state";
    } else {
        btnPlay.innerText = "æš‚åœ";
        btnPlay.style.color = "#ccc";
        tagPause.style.display = "none";
    }

    // 2. å¹²æ”¯å…«å­— (Vertical)
    const gz = getGanZhi(now, sunLon); // [Y, M, D, H]
    const pillars = ['Y','M','D','H'];
    gz.forEach((p, i) => {
        const char = pillars[i];
        document.getElementById(`bz${char}`).innerHTML = 
            `<div>${p[0]}</div><div>${p[1]}</div>`;
        const ny = NAYIN[p];
        const el = document.getElementById(`ny${char}`);
        if(ny) {
            el.innerText = ny.n;
            el.className = `nayin ny-${ny.e}`;
        }
    });

    // 3. æ—¶è¾°
    const h = tTime.getHours();
    const m = tTime.getMinutes();
    const zIdx = Math.floor((h+1)/2)%12;
    const startH = (h%2!==0)?h:(h-1);
    const baseH = (startH<0)?23:startH;
    const minFromStart = ((h-baseH+24)%24)*60 + m;
    const kIdx = Math.floor(minFromStart/15);
    const nextK = 15 - (minFromStart%15);
    document.getElementById('valShichen').innerText = `${ZHI[zIdx]}æ—¶ ${KE[kIdx]}`;
    document.getElementById('valNextKe').innerText = `è·ç¦»ä¸‹åˆ»: ${nextK}åˆ†`;

    // 4. å›å½’é»„é“ (Tropical)
    const sSign = Math.floor(sunLon/30);
    document.getElementById('sunTropName').innerText = ZODIAC[sSign];
    document.getElementById('sunTropDeg').innerText = `${(sunLon%30).toFixed(1)}Â° / 30Â°`;
    document.getElementById('barSunTrop').style.width = `${(sunLon%30)/30*100}%`;
    
    const mSign = Math.floor(moonLon/30);
    document.getElementById('moonTropName').innerText = ZODIAC[mSign];
    document.getElementById('moonTropDeg').innerText = `${(moonLon%30).toFixed(1)}Â° / 30Â°`;
    document.getElementById('barMoonTrop').style.width = `${(moonLon%30)/30*100}%`;

    // 5. æ’æ˜Ÿé»„é“ (Sidereal)
    const sSid = getSiderealInfo(sunLon);
    document.getElementById('sunSidName').innerText = `${sSid.name}å®¿`;
    document.getElementById('sunSidDeg').innerText = `${sSid.deg}Â° / ${sSid.total}Â°`;

    const mSid = getSiderealInfo(moonLon);
    document.getElementById('moonSidName').innerText = `${mSid.name}å®¿`;
    document.getElementById('moonSidDeg').innerText = `${mSid.deg}Â° / ${mSid.total}Â°`;

    // 6. é¢„æµ‹ (ä½é¢‘åˆ·æ–° 1s)
    if (nowReal % 1000 < 50) {
        // æœˆç›¸
        const pAng = norm360(moonLon - sunLon);
        let pName = `æ¸å˜ ${((pAng/360)*100).toFixed(0)}%`;
        let pColor = "#fff";
        if(pAng<6||pAng>354) { pName="ğŸŒ‘ æœ” (New)"; pColor="var(--moon-color)"; }
        else if(Math.abs(pAng-180)<6) { pName="ğŸŒ• æœ› (Full)"; pColor="var(--sun-color)"; }
        else if(Math.abs(pAng-90)<6) pName="ğŸŒ“ ä¸Šå¼¦";
        else if(Math.abs(pAng-270)<6) pName="ğŸŒ— ä¸‹å¼¦";
        
        const elP = document.getElementById('valPhase');
        elP.innerText = pName;
        elP.style.color = pColor;
        
        // é¢„æµ‹ä¸‹ä¸€ç›¸
        // ç®€å•é€»è¾‘ï¼šæ‰¾ä¸‹ä¸€ä¸ª 0,90,180,270
        let target = 0;
        if(pAng<90) target=90; else if(pAng<180) target=180; else if(pAng<270) target=270; else target=0;
        // æš´åŠ›æœ
        let nextPD = predictEvent(jd, (j)=>{
            let s=getPlanetLon(j,'sun'), mn=getPlanetLon(j,'moon');
            let diff=norm360(mn-s);
            let d=Math.abs(diff-target);
            if(target===0) d=Math.min(diff, 360-diff);
            return d<0.5; // hit
        }, true);
        if(nextPD) document.getElementById('nextPhase').innerText = `ä¸‹é˜¶æ®µ: ${fmtFull(nextPD)}`;

        // ç©ºäº¡
        const isVoc = getVoc(jd);
        const elV = document.getElementById('valVoc');
        const elVNx = document.getElementById('nextVoc');
        if(isVoc) {
            elV.innerText = "âš ï¸ ç©ºäº¡ (VOC)";
            elV.style.color = "var(--alert)";
            let endT = predictEvent(jd, (j)=>getVoc(j), false);
            if(endT) elVNx.innerText = `ç»“æŸäº ${fmtFull(endT)}`;
        } else {
            elV.innerText = "ğŸŸ¢ æ­£å¸¸";
            elV.style.color = "var(--time-color)";
            let startT = predictEvent(jd, (j)=>getVoc(j), true);
            if(startT) elVNx.innerText = `ç©ºäº¡å§‹äº ${fmtFull(startT)}`;
        }
    }

    // 7. åæ ‡ä¸EoT
    document.getElementById('valLoc').innerText = `${STATE.lat.toFixed(2)}N ${STATE.lon.toFixed(2)}E`;
    document.getElementById('valEoT').innerText = `EoT: ${eot.toFixed(1)}m`;

    requestAnimationFrame(update);
}

// === 6. äº¤äº’æ§åˆ¶ ===
const APP = {
    jump: (h) => {
        STATE.baseTime = new Date(STATE.baseTime.getTime() + h*3600000);
        STATE.mode = 'manual';
    },
    reset: () => {
        STATE.mode = 'auto';
        STATE.paused = false;
    },
    togglePause: () => {
        STATE.paused = !STATE.paused;
        if(STATE.paused) STATE.mode = 'manual'; // æš‚åœå³è¿›å…¥æ‰‹åŠ¨æ§åˆ¶æµ
    },
    openSet: () => document.getElementById('modalSet').style.display='flex',
    closeSet: () => document.getElementById('modalSet').style.display='none',
    applySet: () => {
        const t = document.getElementById('iptTime').value;
        const lo = parseFloat(document.getElementById('iptLon').value);
        const la = parseFloat(document.getElementById('iptLat').value);
        if(t) {
            STATE.baseTime = new Date(t);
            STATE.mode = 'manual';
            STATE.paused = true; // è®¾å®Œæš‚åœæ–¹ä¾¿çœ‹
        }
        if(!isNaN(lo)) STATE.lon = lo;
        if(!isNaN(la)) STATE.lat = la;
        APP.closeSet();
    }
};

// å¯åŠ¨ GPS
if(navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(p=>{
        if(STATE.mode==='auto') {
            STATE.lat = p.coords.latitude; 
            STATE.lon = p.coords.longitude;
            const el = document.getElementById('gpsInd');
            el.innerText = `GPS: é”å®š Â±${p.coords.accuracy.toFixed(0)}m`;
            el.className = 'gps-active';
        }
    });
}

// å¯åŠ¨
const t = new Date();
const iso = new Date(t.getTime() - t.getTimezoneOffset()*60000).toISOString().slice(0,16);
document.getElementById('iptTime').value = iso;
requestAnimationFrame(update);

</script>
</body>
</html>
