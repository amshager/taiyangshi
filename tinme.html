<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>终极真太阳时</title>
    <style>
        body {
            background-color: #000000;
            color: #00ff00; /* 经典的终端绿 */
            font-family: 'Courier New', Courier, monospace;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            text-align: center;
        }
        h1 { font-size: 1.5rem; margin-bottom: 0.5rem; color: #fff; }
        .time-display {
            font-size: 3.5rem;
            font-weight: bold;
            margin: 10px 0;
            text-shadow: 0 0 10px #00ff00;
        }
        .info-box {
            border: 1px solid #333;
            padding: 15px;
            border-radius: 8px;
            background-color: #111;
            width: 80%;
            max-width: 400px;
            margin-top: 20px;
        }
        .data-row {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            font-size: 0.9rem;
            color: #aaa;
        }
        .data-val { color: #fff; font-weight: bold; }
        .shichen {
            font-size: 2rem;
            color: #ffcc00; /* 醒目的黄色 */
            margin-top: 10px;
            border: 1px solid #ffcc00;
            padding: 5px 20px;
            display: inline-block;
        }
        #status { color: #ff3333; font-size: 0.8rem; margin-top: 10px;}
        .shichen-risk { font-size: 0.8rem; color: #ff3333; display: block; margin-top: 5px;}
    </style>
</head>
<body>

    <h1>真太阳时罗盘</h1>
    
    <div class="time-display" id="trueSolarTime">--:--:--</div>
    
    <div id="shichenBox" class="shichen">等待定位...</div>
    <span id="shichenRisk" class="shichen-risk"></span>

    <div class="info-box">
        <div class="data-row"><span>平太阳时(手表):</span> <span class="data-val" id="clockTime">--:--:--</span></div>
        <div class="data-row"><span>GPS经度:</span> <span class="data-val" id="lon">--</span></div>
        <div class="data-row"><span>经度修正:</span> <span class="data-val" id="lonCorr">--</span></div>
        <div class="data-row"><span>均时差(EoT):</span> <span class="data-val" id="eotCorr">--</span></div>
        <div id="status">正在请求卫星权限...</div>
    </div>

    <script>
        // --- 核心算法区 ---
        
        // 1. 计算均时差 (EoT) - 输入：Date对象, 输出：分钟修正值
        function calculateEoT(date) {
            // 获取当年第几天 (Day of Year)
            const start = new Date(date.getFullYear(), 0, 0);
            const diff = date - start;
            const oneDay = 1000 * 60 * 60 * 24;
            const dayOfYear = Math.floor(diff / oneDay);

            // 简易高精度算法
            const B = (360 / 365) * (dayOfYear - 81);
            const B_rad = B * (Math.PI / 180); // 转弧度

            const eot = 9.87 * Math.sin(2 * B_rad) 
                      - 7.53 * Math.cos(B_rad) 
                      - 1.5 * Math.sin(B_rad);
            return eot; 
        }

        // 2. 时辰判定逻辑
        function getShichen(date) {
            const h = date.getHours();
            const m = date.getMinutes();
            const timeVal = h + m / 60.0;
            
            // 地支对应 (23-1 子, 1-3 丑, 3-5 寅...)
            const zhi = ["子", "丑", "寅", "卯", "辰", "巳", "午", "未", "申", "酉", "戌", "亥"];
            // 简单的索引算法：(小时 + 1) / 2 取整，模12
            let index = Math.floor((h + 1) / 2) % 12;
            
            // 边界预警：如果在换运的前后1分钟内
            let riskWarning = "";
            // 计算距离下一个奇数整点还有多久
            let nextOddHour = (Math.floor(timeVal) % 2 !== 0) ? Math.floor(timeVal) + 2 : Math.floor(timeVal) + 1;
            if (nextOddHour === 25) nextOddHour = 1; 
            
            // 简单判断：如果分钟是 59 或 00，提示并在边界
            if (m === 59) riskWarning = "⚠️ 即将换运 (剩<1分钟)";
            if (m === 0) riskWarning = "⚠️ 刚刚换运 (过去<1分钟)";

            return { name: zhi[index] + "时", risk: riskWarning };
        }

        // --- GPS 与 页面更新区 ---

        const elTrueTime = document.getElementById('trueSolarTime');
        const elClockTime = document.getElementById('clockTime');
        const elLon = document.getElementById('lon');
        const elLonCorr = document.getElementById('lonCorr');
        const elEotCorr = document.getElementById('eotCorr');
        const elStatus = document.getElementById('status');
        const elShichen = document.getElementById('shichenBox');
        const elRisk = document.getElementById('shichenRisk');

        let currentLon = null;

        // 启动 GPS 监听
        if ("geolocation" in navigator) {
            navigator.geolocation.watchPosition(
                (position) => {
                    // 成功获取位置
                    currentLon = position.coords.longitude;
                    elLon.innerText = currentLon.toFixed(4) + "°";
                    elStatus.innerText = "GPS信号良好 (精度:" + position.coords.accuracy.toFixed(0) + "米)";
                    elStatus.style.color = "#00ff00";
                    updateDisplay();
                },
                (error) => {
                    // 失败处理
                    let errMsg = "";
                    switch(error.code) {
                        case error.PERMISSION_DENIED: errMsg = "定位权限被拒绝"; break;
                        case error.POSITION_UNAVAILABLE: errMsg = "搜星失败，请到室外"; break;
                        case error.TIMEOUT: errMsg = "定位超时"; break;
                        default: errMsg = "未知错误";
                    }
                    elStatus.innerText = "⚠️ " + errMsg;
                },
                {
                    enableHighAccuracy: true, // 【关键】强制高精度(硬件GPS)
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        } else {
            elStatus.innerText = "您的浏览器不支持定位";
        }

        // 实时刷新时钟 (每秒)
        setInterval(updateDisplay, 1000);

        function updateDisplay() {
            const now = new Date();
            elClockTime.innerText = now.toLocaleTimeString('en-GB', {hour12: false}); // 24小时制

            if (currentLon === null) return; // 还没定位到，不计算

            // 1. 经度差修正 (以北京时间东经120度为准)
            // 如果你在中国，标准经线是120。
            // 修正值 = (当地经度 - 120) * 4 分钟
            const deltaLonMin = (currentLon - 120.0) * 4;
            
            // 2. 均时差修正
            const eotMin = calculateEoT(now);

            // 3. 总修正
            const totalOffsetMin = deltaLonMin + eotMin;
            
            // 4. 计算真太阳时对象
            // getTime() 是毫秒，所以要 * 60 * 1000
            const trueSolarTimeObj = new Date(now.getTime() + totalOffsetMin * 60 * 1000);

            // 更新UI
            elTrueTime.innerText = trueSolarTimeObj.toLocaleTimeString('en-GB', {hour12: false});
            elLonCorr.innerText = (deltaLonMin > 0 ? "+" : "") + deltaLonMin.toFixed(2) + "分";
            elEotCorr.innerText = (eotMin > 0 ? "+" : "") + eotMin.toFixed(2) + "分";

            const shichenData = getShichen(trueSolarTimeObj);
            elShichen.innerText = shichenData.name;
            elRisk.innerText = shichenData.risk;
        }

    </script>
</body>
</html>